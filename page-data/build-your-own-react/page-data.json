{"componentChunkName":"component---src-templates-blog-js","path":"/build-your-own-react/","result":{"data":{"site":{"siteMetadata":{"title":"Fish's Blog"}},"markdownRemark":{"id":"87a8465c-204d-5bcf-a903-7fca9c8a4fd0","excerpt":"原文: Build your own React 这是一个从零开始实现 React 的教程，与生产版本有所差异的是，我们会忽略所有优化的细节，同时忽略一些与主要原理无关的特性。 也许你阅读过我之前写过的类似教程，这篇教程与之前教程的区别是，本教程的源代码基于 React 16.8 版本，因此本教程包含了 hooks…","html":"<p>原文: <a href=\"https://pomb.us/build-your-own-react/\">Build your own React</a></p>\n<!-- ```toc\n# This code block gets replaced with the TOC\n``` -->\n<p>这是一个从零开始实现 React 的教程，与生产版本有所差异的是，我们会忽略所有优化的细节，同时忽略一些与主要原理无关的特性。</p>\n<p>也许你阅读过我之前写过的<a href=\"https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5\">类似教程</a>，这篇教程与之前教程的区别是，本教程的源代码基于 React 16.8 版本，因此本教程包含了 hooks 的特性，同时不包含 class 版本组件的实现。</p>\n<p>如果你同时希望学习旧版本的实现，可以查看旧版的教程以及与之相关的旧版<a href=\"https://github.com/pomber/didact\">实现源码</a>。同时还有一个<a href=\"https://www.youtube.com/watch?v=8Kc2REHdwnQ&#x26;feature=youtu.be\">视频解说</a>以供参考。不过阅读本教程并不强制要求你学习过之前的版本，本教程的内容是独立完整的。</p>\n<p>我将实现过程拆分成了以下几个部分：</p>\n<ol>\n<li>实现 <code class=\"language-text\">createElement</code> 函数</li>\n<li>实现 <code class=\"language-text\">render</code> 函数</li>\n<li>Concurrent 模式</li>\n<li>Fibers</li>\n<li>渲染与提交阶段 (Commit)</li>\n<li>协调 Reconciliation</li>\n<li>函数式组件</li>\n<li>Hooks</li>\n</ol>\n<h2 id=\"概览\" style=\"position:relative;\"><a href=\"#%E6%A6%82%E8%A7%88\" aria-label=\"概览 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>概览</h2>\n<p>首先我们来看几个基本概念。如果你对 React，JSX 和 DOM 元素的实现已经有了比较深刻的理解，可以跳过这部分的介绍直接进入下一部分。</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span> <span class=\"token attr-name\">title</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>foo<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hello</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n<span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">)</span>\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">)</span></code></pre></div>\n<p>这是一个简单的 React 应用，仅仅包含了三行代码。第一行定义了一个 React 元素。第二行利用 Web API 获取了 DOM 中的某一个节点，我将它称为容器。最后一行则是将我们的 React 元素插入到容器的操作。</p>\n<p><strong>现在我们把所有 React 相关的代码全部替换为原生 JavaScript 代码。</strong></p>\n<p>第一行代码，使用的是 JSX 语法，它并不是原生的 JavaScript 代码，因此我们对它做出一些修改：</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> title<span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"Hello\"</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>JSX 代码会被类似 Babel 的编译工具进行处理，转换成原生 JavaScript 代码。转换过程比较简单：将 <code class=\"language-text\">&lt;</code> <code class=\"language-text\">&gt;</code> 标签移除，使用 <code class=\"language-text\">createElement</code> 函数调用进行替换，传入的参数分别为：标签名称，元素参数，以及元素的子元素。</p>\n<p><code class=\"language-text\">React.createElement</code> ，根据所传入的参数，创建了一个对象。除了一些有效性校验之外，整体的功能就是以上这样。因此我们可以直接把 JSX 替换成原生 JavaScript 的形式，人工确保元素和属性等的有效性。</p>\n<p>经过以上处理之后，我们的元素就变成了这样的形式：一个对象，内部含有两个属性，分别是 <code class=\"language-text\">type</code> 和 <code class=\"language-text\">props</code> (当然了，实际上<a href=\"https://github.com/facebook/react/blob/f4cc45ce962adc9f307690e1d5cfa28a288418eb/packages/react/src/ReactElement.js#L111\">包含更多</a>，目前我们只关注这两个就可以。）</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    title<span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">,</span>\n    children<span class=\"token operator\">:</span> <span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">type</code> 属性的值是字符串类型，表示我们所希望创建的 DOM 元素类型，相当于当你希望创建一个 HTML 元素的时候，传入 <code class=\"language-text\">document.createElement</code> 函数中的标签名。当然除了字符串类型之外，<code class=\"language-text\">type</code> 的值还可以是一个函数，这点我们会在函数式组件的那一部分中详细介绍。</p>\n<p><code class=\"language-text\">props</code> 是另一个对象，其中的内容包括所有 JSX 属性中的键值对。有一个特殊的属性需要特别关注，就是 <code class=\"language-text\">children</code> 。</p>\n<p>在我们当前的示例中，<code class=\"language-text\">children</code> 的值是一个字符串，不过在大多数情况下，<code class=\"language-text\">children</code> 的值会是一个包含很多元素的数组。这也是为什么, 元素的数据结构是树的原因。</p>\n<p>我们的简易 React 应用中，第三行代码（<code class=\"language-text\">ReactDOM.render</code>）也不是原生的 JavaScript 代码，同样需要进行转换。</p>\n<p>在 <code class=\"language-text\">render</code> 方法中，React 元素被转换并渲染到了 DOM 中，现在我们要用自己的方法去实现这一步。</p>\n<p>首先需要做的是，利用第一步的 <code class=\"language-text\">type</code> 属性，创建一个 DOM 节点，本例中我们的 <code class=\"language-text\">type</code> 属性是 <code class=\"language-text\">h1</code> 标签。</p>\n<p>然后，我们将所有元素属性都赋到对应的 DOM 节点中。本例中只有 title 属性。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span>\nnode<span class=\"token punctuation\">[</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>title</code></pre></div>\n<p>为了避免混淆，我会用“元素”来表示 React 元素，“节点”来表示 DOM 元素。</p>\n<p>接下来要处理子元素所对应的节点了。本例中我们的子元素是文本，因此只需要创建一个文本节点即可。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\ntext<span class=\"token punctuation\">[</span><span class=\"token string\">\"nodeValue\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children</code></pre></div>\n<p>渲染文本节点使用的是 <code class=\"language-text\">createTextNode</code> 而不是 <code class=\"language-text\">innerText</code>, 可以保证在后续处理元素时, 所有元素的形式都是一致的, 抹平差异, 统一处理. 使用 <code class=\"language-text\">createTextNode</code> 时, 文本也是属性, key 为 <code class=\"language-text\">nodeValue</code> ，与之前针对 <code class=\"language-text\">h1</code> 的处理是类似的：<code class=\"language-text\">props: {nodeValue: &quot;hello&quot;}</code> </p>\n<p>最后将 <code class=\"language-text\">textNode</code> 添加到 <code class=\"language-text\">h1</code> ，将 <code class=\"language-text\">h1</code> 添加到容器中。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    title<span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">,</span>\n    children<span class=\"token operator\">:</span> <span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span>\nnode<span class=\"token punctuation\">[</span><span class=\"token string\">\"title\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>title\n\n<span class=\"token keyword\">const</span> text <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\ntext<span class=\"token punctuation\">[</span><span class=\"token string\">\"nodeValue\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n\nnode<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\ncontainer<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">)</span></code></pre></div>\n<p>至此，我们实现了与之前一致的应用，并且没有使用任何与 React 相关的代码。</p>\n<h2 id=\"实现-createelement-函数\" style=\"position:relative;\"><a href=\"#%E5%AE%9E%E7%8E%B0-createelement-%E5%87%BD%E6%95%B0\" aria-label=\"实现 createelement 函数 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>实现 createElement 函数</h2>\n<p>现在我们开始实现另一个应用。这次将 React 相关的代码替换成我们自己版本的 React。</p>\n<p>首先开始实现我们的 <code class=\"language-text\">createElement</code> 。</p>\n<p>还是先将 JSX 转换成 JS，以便看到 <code class=\"language-text\">createElement</code> 函数调用。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>foo<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">bar</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>b</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">)</span>\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">)</span></code></pre></div>\n<p>在之前的步骤中我们知道了：元素就是一个对象，内含有 <code class=\"language-text\">type</code> 和 <code class=\"language-text\">props</code> 属性。因此我们的 <code class=\"language-text\">createElement</code> 函数需要做的就是创建这个元素对象。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>props<span class=\"token punctuation\">,</span>\n      children<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们使用  ES6 中的展开操作符来处理 <code class=\"language-text\">props</code> 属性，剩余参数语法来处理 <code class=\"language-text\">children</code> 属性，这样的话 <code class=\"language-text\">children</code> 属性就始终是一个数组。</p>\n<p>举个例子，<code class=\"language-text\">createElement(&quot;div&quot;)</code> 函数返回的内容是：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"props\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"children\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">createElement(&quot;div&quot;, null, a)</code> 函数返回的内容是：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"props\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"children\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">createElement(&quot;div&quot;, null, a, b)</code> 函数返回的内容是：</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"props\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"children\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">children</code> 数组的内容还可以是原始类型的值，字符串或者数字。现在我们将所有非对象类型的元素用一个特殊的类型 <code class=\"language-text\">TEXT_ELEMENT</code> 来表示。</p>\n<p>在没有 <code class=\"language-text\">children</code> 的情况下，React 不会封装原始类型的值或者是创建一个空数组，我们这样做的原因是为了简化代码，毕竟简单的代码更利于教学。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>props<span class=\"token punctuation\">,</span>\n      children<span class=\"token operator\">:</span> children<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span>\n        <span class=\"token keyword\">typeof</span> child <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span>\n          <span class=\"token operator\">?</span> child\n          <span class=\"token operator\">:</span> <span class=\"token function\">createTextElement</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createTextElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">text</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> <span class=\"token string\">\"TEXT_ELEMENT\"</span><span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      nodeValue<span class=\"token operator\">:</span> text<span class=\"token punctuation\">,</span>\n      children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"bar\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">)</span>\nReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">)</span></code></pre></div>\n<p>目前我们依然在用 React 的 <code class=\"language-text\">createElement</code> 。</p>\n<p>现在给我们自己的库起个名字，来替换它。为了体现它的教学意义，又保持与 React 的名字类似，我们将这个库叫做 Didact 。</p>\n<p>不过我还是想要使用 JSX 语法，因此我们需要告诉 babel，去使用 Didact 的 <code class=\"language-text\">createElement</code> 而不是 React 的 <code class=\"language-text\">createElement</code> 。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> Didact <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  createElement<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> Didact<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  Didact<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"bar\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  Didact<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>只需要简单地加上这个注释，就能够达到我们的目的了：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">/** @jsx Didact.createElement */</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>foo<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">bar</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>b</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"实现-render-方法\" style=\"position:relative;\"><a href=\"#%E5%AE%9E%E7%8E%B0-render-%E6%96%B9%E6%B3%95\" aria-label=\"实现 render 方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>实现 render 方法</h2>\n<p>接下来我们要开始实现自己的 <code class=\"language-text\">ReactDOM.render</code> 函数。</p>\n<p>目前，我们只需要关注在 DOM 中添加内容即可。元素的更新和删除都在后续的章节中进行阐述。</p>\n<p>首先使用元素的类型创建 DOM 节点，然后将所创建的节点添加到我们的容器中。</p>\n<p>针对所有的 <code class=\"language-text\">children</code> 都要去递归地处理。</p>\n<p>与此同时还要处理文本类型的元素，创建文本节点而非普通节点。</p>\n<p>最后将元素的属性都添加到 node 节点中。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span>\n    element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> <span class=\"token string\">\"TEXT_ELEMENT\"</span>\n      <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isProperty</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> key <span class=\"token operator\">!==</span> <span class=\"token string\">\"children\"</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isProperty<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span>\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n\n  container<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>以上整体代码见：<a href=\"https://codesandbox.io/s/didact-2-k6rbj\">React</a>.</p>\n<h2 id=\"实现-concurrent-模式\" style=\"position:relative;\"><a href=\"#%E5%AE%9E%E7%8E%B0-concurrent-%E6%A8%A1%E5%BC%8F\" aria-label=\"实现 concurrent 模式 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>实现 Concurrent 模式</h2>\n<p>在开始实现 Concurrent 模式之前要对我们的代码进行重构。</p>\n<p>之前版本的递归调用有一点问题:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> dom<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>一旦组件开始进行渲染的进程，只有等全部的组件树渲染完毕后渲染流程才会结束。如果组件树过大的话，会长时间阻碍主进程。当浏览器要执行优先级高的操作（比如处理用户输入或者动画时），都需要等待渲染的结束，对性能造成比较大的影响。</p>\n<p>因此我们要将渲染的流程拆分成一个个小的单元，在各个单元之间，我们可以暂停渲染进程，允许浏览器执行其他操作。</p>\n<p>我们使用 <code class=\"language-text\">[requestIdleCallback](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback)</code> (浏览器提供的一个 API )来创建一个循环。为了便于理解可以将 <code class=\"language-text\">requestIdleCallback</code> 看作是 <code class=\"language-text\">setTimeout</code>，区别就是，<code class=\"language-text\">setTimeout</code> 受时间控制，而 <code class=\"language-text\">requestIdleCallback</code>  则是在主进程处于空闲的情况下被浏览器执行的。</p>\n<p>现在 <a href=\"https://github.com/facebook/react/issues/11171#issuecomment-417349573\">React 已经不再使用</a> <code class=\"language-text\">requestIdleCallback</code> 了，目前它的替代方案是 <a href=\"https://github.com/facebook/react/tree/master/packages/scheduler\">scheduler</a> 包。不过两者所实现的主要功能相差无几。</p>\n<p><code class=\"language-text\">requestIdleCallback</code> 还接受一个类似最后期限 （deadline）的参数。我们可以利用这个参数知道浏览器还有多长时间之后, 会重新获取控制权。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> shouldYield <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">// 停止操作的 flag</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>shouldYield<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>\n      nextUnitOfWork\n    <span class=\"token punctuation\">)</span>\n    shouldYield <span class=\"token operator\">=</span> deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>workLoop<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>workLoop<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">nextUnitOfWork</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>截止本文撰写的时间（2019年11月），Concurrent 模式在 React 中还并非稳定特性，处于实验阶段。稳定版本的循环代码大概像是下面这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>    \n  nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>   \n    nextUnitOfWork  \n  <span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>要想开始这段循环 (workLoop)，首先要设置首个单元的进程，然后实现 <code class=\"language-text\">performUnitOfWork</code> 函数，处理当前单元的渲染进程，并返回下一个单元的进程。</p>\n<h2 id=\"fibers\" style=\"position:relative;\"><a href=\"#fibers\" aria-label=\"fibers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fibers</h2>\n<p>想要组织渲染进程的各个单元，我们需要依赖的数据结构是 fiber 树。</p>\n<p>一个 fiber 代表每一个元素，而每一个 fiber 也是进程的一个单元。</p>\n<p>下面看这个例子。</p>\n<p>假设我们需要渲染的元素类似如下这样, 他的 fiber 树就如右图.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">Didact<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h2</span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span>\n  container\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/d7e94c6d4027b55b401a631461f32b5b/41d3b/fiber.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.26582278481011%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACVklEQVQ4y4VU6VriQBD0NVSSzH3kBJJICCDerq4r677/u9R+mZCYIOKP+Whm0jVVXd1zFjCFY8un8uT/79bZKbBJwHHpM3hEDPa/Lp+qffwNYJdsowzZrICJsv6SJrlZE6JwEWj4TA1ATwA27JbrLV7edpiXVc9SCgEpBfKY4WYWgDIBj3ag8jtA6W72A4YkUVDGwCMtQ2MVrFWoC4XXa40ksf3ZiOG46BITqhBqjrq0sHGMSdAyVDaEDkNs7ys8/r5GVc+/Ag5N6KR5REFyAqNYL6fZpyYDMSmizS/EDx+w62cQbvrzsy5o3KzqDdJZ4eKAa9S393h6eUN6tYBH5VjF3nEi7UhhL/nCo3h8fkFZ1S4mXCOeFcjLBUw6dclU6IHbn7/DuAdspK42N9Bh6mLXBgHBfKqgrQEVCleLFISrUc0O699LvvAY1ttbzIpF28xUI9IMVa6howiXvgBXGrM8dqAds0OmPcNzj+L97z8sV9c4nxD4TENKiTC0Tn7XvExqx7bJ4ao9GzEcSr65e4CNM+e2zySWdw+4f3pFVJQuiUVz6HKDQEVYbLf4s/vAfLXuO6OX3N3Q1u5TApcGcZqAq7aGwwanwrh6U2mPm3LY2M04cc6wyA1sHLr98iqF1C1o8/0hgdOTQppJYchTCWHsflIksmnk2P4IeOy1EUrDRjGI2JvCNKgKndzGDBUm7uyoKcdem2lV4+l9Bxmn8ImESHLoYo1AhjDZFM+7Hex0Di8QPwO6W6kE2Zvl9hqJhLc9t6+jP3p8f3ixfSa/1Gj03ZFJ+Q+ogj5cta60PQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber\"\n        title=\"fiber\"\n        src=\"/blog/static/d7e94c6d4027b55b401a631461f32b5b/f058b/fiber.png\"\n        srcset=\"/blog/static/d7e94c6d4027b55b401a631461f32b5b/c26ae/fiber.png 158w,\n/blog/static/d7e94c6d4027b55b401a631461f32b5b/6bdcf/fiber.png 315w,\n/blog/static/d7e94c6d4027b55b401a631461f32b5b/f058b/fiber.png 630w,\n/blog/static/d7e94c6d4027b55b401a631461f32b5b/41d3b/fiber.png 774w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在 <code class=\"language-text\">render</code> 方法中， 我们会创建一个根 fiber, 然后将其设置为 <code class=\"language-text\">nextUnitOfWork</code> (下一个执行单元）。之后的流程则在 <code class=\"language-text\">performUnitOfWork</code> (执行当前工作单元)函数中实现，在这个函数中，我们会针对每一个 fiber 执行如下操作：</p>\n<ol>\n<li>将元素添加到 DOM 中</li>\n<li>为元素的子元素创建各自的 fiber</li>\n<li>返回下一个执行单元(需要被处理的 fiber)</li>\n</ol>\n<p>我们选择 fiber 数据结构的原因是便于找到下一个执行单元。这也是为什么每一个 fiber 都与它的第一个子节点，相邻的兄弟节点和父节点都存在关联关系的原因。</p>\n<p>当我们在<code class=\"language-text\">performUnitOfWork</code> 中做好处理 fiber 的任务之后,  如果这个 fiber 有一个 <code class=\"language-text\">child</code> 子节点，那么这个子节点对应的 fiber 就是下一个执行单元。</p>\n<p>在我们的示例中，<code class=\"language-text\">h1</code> 是 <code class=\"language-text\">div</code> 之后的一个执行单元 。</p>\n<p>如果某个 fiber 没有子节点的话，那么紧接的执行单元就是兄弟节点。</p>\n<p>例子中，fiber <code class=\"language-text\">p</code> 没有子节点，因此 <code class=\"language-text\">a</code> 就是下一个执行单元。</p>\n<p>如果 fiber 既没有子节点，也没有兄弟节点，那么就会寻找该 fiber 的”叔叔节点”：也就是父节点的兄弟节点，就比如我们例子中的 <code class=\"language-text\">a</code> 和 <code class=\"language-text\">h2</code> 。</p>\n<p>如果父节点不存在兄弟节点，那么我们还会不断向上追溯，寻找这类节点，直到到达根节点为止。到了根节点也意味着，针对这次渲染的所有细分单元工作, 我们均已完成。</p>\n<p>现在以代码形式来呈现这一切。</p>\n<p>首先从 <code class=\"language-text\">render</code> 中删除渲染的代码, 我们将具体的渲染工作都交付给 <code class=\"language-text\">performUnitOfWork</code></p>\n<p>将创建 DOM 节点的方法封装成 <code class=\"language-text\">createDom</code>，后续使用。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">createDOM</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span>\n    element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> <span class=\"token string\">\"TEXT_ELEMENT\"</span>\n      <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isProperty</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> key <span class=\"token operator\">!==</span> <span class=\"token string\">\"children\"</span><span class=\"token punctuation\">;</span>\n\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isProperty<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">propName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">[</span>propName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> dom<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 <code class=\"language-text\">render</code> 方法中，我们给 <code class=\"language-text\">nextUnitOfWork</code> (下一个工作单元）赋值为 fiber 树的根节点。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    dom<span class=\"token operator\">:</span> container<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>element<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当浏览器准备就绪的时候，会调用 <code class=\"language-text\">workLoop</code> 方法，于是就会从根节点开始我们的渲染进程。</p>\n<p>在 <code class=\"language-text\">performUnitOfWork</code> 方法中: </p>\n<p>我们首先创建一个新的节点, 然后将其添加到 DOM 中。这个新节点会存储在 <code class=\"language-text\">fiber.dom</code> 中:</p>\n<p>然后针对每一个子元素，我们都创建一个新的 fiber 。</p>\n<p>之后将其添加到 fiber 树中，根据情况设置为子节点或者是兄弟节点。</p>\n<p>最后我们实现对下一个工作单元的搜寻工作。首先是子节点，接着是兄弟节点，然后是叔叔节点，以此类推。</p>\n<p>最后就实现了 <code class=\"language-text\">performUnitOfWork</code> 方法。下面是完整的代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// 新增 DOM 节点</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> <span class=\"token function\">createDom</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// 对每一个 child 都创建一个新的 fiber </span>\n  <span class=\"token keyword\">const</span> elements <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n  <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">let</span> prevSibling <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> elements<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> elements<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span>\n      props<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n      parent<span class=\"token operator\">:</span> fiber<span class=\"token punctuation\">,</span>\n      dom<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      fiber<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> newFiber\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      prevSibling<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber\n    <span class=\"token punctuation\">}</span>\n\n    prevSibling <span class=\"token operator\">=</span> newFiber\n    index<span class=\"token operator\">++</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">.</span>child\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> nextFiber <span class=\"token operator\">=</span> fiber\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextFiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextFiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> nextFiber<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token punctuation\">}</span>\n    nextFiber <span class=\"token operator\">=</span> nextFiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"渲染与提交阶段-commit\" style=\"position:relative;\"><a href=\"#%E6%B8%B2%E6%9F%93%E4%B8%8E%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5-commit\" aria-label=\"渲染与提交阶段 commit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>渲染与提交阶段 Commit</h2>\n<p>现在我们又遇到了另一个问题。</p>\n<p>每开始处理一个元素，我们都会创建一个新的节点到 DOM 中。但是根据目前的代码实现, 在整棵树在 DOM 中渲染完成之前，浏览器是有机会阻碍我们渲染流程的进行的。这样的话，用户就很可能会在此过程中看见一个不完整的 UI ，这不是我们所期待的行为。</p>\n<p>因此我们要把引起 DOM 变化部分的代码移除。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token operator\">~</span><span class=\"token operator\">~</span><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token operator\">~</span><span class=\"token operator\">~</span></code></pre></div>\n<p>同时，要开始监视 fiber 树根节点的变化。我们将监视变化的节点叫做 <code class=\"language-text\">wipRoot</code> 。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  wipRoot <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    dom<span class=\"token operator\">:</span> container<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>element<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n  nextUnitOfWork <span class=\"token operator\">=</span> wipRoot\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> wipRoot <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n\t<span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// 见上</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>一旦所有工作完成之后（当没有下一个工作单元的时候，就表示所有工作都完成了），再将最终的 fiber 树交给 DOM。</p>\n<p>这部分的工作，交给 <code class=\"language-text\">commitRoot</code> 函数来完成。在这里我们递归地将所有节点添加到 DOM 中。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>wipRoot<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  wipRoot <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom\n  domParent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"协调-reconciliation\" style=\"position:relative;\"><a href=\"#%E5%8D%8F%E8%B0%83-reconciliation\" aria-label=\"协调 reconciliation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>协调 Reconciliation</h2>\n<p>截止目前，我们依然只是简单地添加节点到 DOM 中，那么更新和删除 DOM 节点需要怎么处理呢？</p>\n<p>接下来要开始这部分的处理，我们要对在 <code class=\"language-text\">render</code> 方法中获取到的 fiber 树，与前一次已经插入到 DOM 中的 fiber 树进行对比。</p>\n<p>因此，我们需要在 fiber 树在被插入 DOM 中之前，把它缓存下来，作为对比的对象，我们把它叫做：<code class=\"language-text\">currentRoot</code> </p>\n<p>对于每一个 fiber，我们还会添加一个属性：<code class=\"language-text\">alternate</code> ，它是与旧版本 fiber 的连接，也就是之前缓存下来的前一个版本的 fiber 树中的内容。</p>\n<p>现在将 <code class=\"language-text\">performUnitOfWork</code> 方法中创建新 fiber 的代码提取出来，添加到一个名为 <code class=\"language-text\">reconcileChildren</code> 方法中。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> <span class=\"token function\">createDom</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> elements <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> elements<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">.</span>child\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> nextFiber <span class=\"token operator\">=</span> fiber\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextFiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextFiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> nextFiber<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token punctuation\">}</span>\n    nextFiber <span class=\"token operator\">=</span> nextFiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后我们开始处理旧的 fiber 和新的元素们。</p>\n<p>同时对旧 fiber 的子节点们（<code class=\"language-text\">wipFiber.alternate</code>）和新元素的数组进行循环遍历的操作。</p>\n<p>如果我们忽略所有进行循环遍历的样板代码，会发现在循环中最重要的内容是 <code class=\"language-text\">oldFiber</code> 和 <code class=\"language-text\">element</code> 。<code class=\"language-text\">**element</code> 是我们希望渲染到 DOM 中的内容，<code class=\"language-text\">oldFiber</code> 是前一次渲染的 fiber 树。**</p>\n<p>我们需要对它们进行对比, 以确定我们是否需要对 DOM 做出任何修改的操作.</p>\n<p>具体方式是对比类型:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> sameType <span class=\"token operator\">=</span> oldFiber <span class=\"token operator\">&amp;&amp;</span> element <span class=\"token operator\">&amp;&amp;</span> element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> oldFiber<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO update the node</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>element <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO add this node</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO delete the oldFiber's node</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>如果旧的 fiber 和新的元素类型是一样的, 我们就保持原先的 DOM 节点, 直接使用新的 props 更新.</li>\n<li>如果两个类型不一致, 并且有新的元素出现, 那么我们就要创建一个新的 DOM 节点.</li>\n<li>如果两个类型不一致, 但是旧的 filber 依然存在, 那么我们就要移除旧有节点.</li>\n</ul>\n<p>在这里, React 还使用了 key 以更好地实现协调. 举个例子, 当元素的子元素在元素数组中改变位置时, 也会被检测到.</p>\n<p>当旧的 fiber 与新的元素类型一致时, 我们开始创建一个新的 fiber 来隔离 DOM 节点与旧的 fiber, 以及元素中传下来的 props.</p>\n<p>与此同时, 我们还会给 fiber 添加一个新的属性: <code class=\"language-text\">effectTag</code> , 在提交阶段使用:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  newFiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> oldFiber<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n    dom<span class=\"token operator\">:</span> oldFiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span>\n    parent<span class=\"token operator\">:</span> wipFiber<span class=\"token punctuation\">,</span>\n    alternate<span class=\"token operator\">:</span> oldFiber<span class=\"token punctuation\">,</span>\n    effectTag<span class=\"token operator\">:</span> <span class=\"token string\">\"UPDATE\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>对于需要一个新 DOM 节点的情况, 我们将 <code class=\"language-text\">effectTag</code> 的值设为 <code class=\"language-text\">PLACEMENT</code></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>element <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  newFiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n    dom<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    parent<span class=\"token operator\">:</span> wipFiber<span class=\"token punctuation\">,</span>\n    alternate<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    effectTag<span class=\"token operator\">:</span> <span class=\"token string\">\"PLACEMENT\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后是需要删除 DOM 节点的情况, 我们不需要创建新 fiber, 只需要将值为 <code class=\"language-text\">DELETION</code> 的 <code class=\"language-text\">effectTag</code> 属性添加到旧的 fiber 上即可.</p>\n<p>不过当我们将这个 fiber 树提交给 DOM 时, 需要通过 work in progress 节点 (<code class=\"language-text\">wipRoot</code>), 其中不包含旧的 fibers.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  oldFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> <span class=\"token string\">\"DELETION\"</span><span class=\"token punctuation\">;</span>\n  deletions<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>oldFiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>因此我们需要有一个数组来存储需要被删除的 fibers.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  wipRoot <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    dom<span class=\"token operator\">:</span> container<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>element<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    alternate<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n  deletions <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  nextUnitOfWork <span class=\"token operator\">=</span> wipRoot\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> currentRoot <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> wipRoot <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> deletions <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></code></pre></div>\n<p>当我们将改动提交给 DOM 时, 我们需要的就是以上数组中的 fibers.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  deletions<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>commitWork<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>wipRoot<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  currentRoot <span class=\"token operator\">=</span> wipRoot\n  wipRoot <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>现在我们开始修改 <code class=\"language-text\">commitWork</code> 函数以处理这些新的 <code class=\"language-text\">effectTag</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom\n  domParent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果 fiber 的 effectTag 属性值为 <code class=\"language-text\">PLACEMENT</code>, 我们还是执行同样的操作, 将 DOM 节点添加到父 fiber 对应的节点中,</p>\n<p>如果是 <code class=\"language-text\">DELETION</code> 的话, 则删除这个子节点.</p>\n<p>如果是 <code class=\"language-text\">UPDATE</code> 的话, 则更新已存在的 DOM 节点, 同时更新 props, 具体的操作在 <code class=\"language-text\">updateDom</code> 方法中实现</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"PLACEMENT\"</span> <span class=\"token operator\">&amp;&amp;</span> fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"UPDATE\"</span> <span class=\"token operator\">&amp;&amp;</span> fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">updateDom</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"DELETION\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">updateDom</code> 中, 我们对比新旧 fiber 中的 props, 移除已经不存在的 props, 更新新建的或者是已经改变的 props.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isProperty</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> key <span class=\"token operator\">!==</span> <span class=\"token string\">\"children\"</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isNew</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">prev<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">key</span> <span class=\"token operator\">=></span>\n  prev<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> next<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isGone</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">prev<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">in</span> next<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateDom</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dom<span class=\"token punctuation\">,</span> prevProps<span class=\"token punctuation\">,</span> nextProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Remove old properties</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isProperty<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token function\">isGone</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">,</span> nextProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Set new or changed properties</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nextProps<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isProperty<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">,</span> nextProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nextProps<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其中有一类 prop 比较特殊, 就是事件处理器, 我们通过 prop 名中是否含有 <code class=\"language-text\">on</code> 前缀来判断是否是这类 prop.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isEvent</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> key<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"on\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isProperty</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">key</span> <span class=\"token operator\">=></span>\n  key <span class=\"token operator\">!==</span> <span class=\"token string\">\"children\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">isEvent</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span></code></pre></div>\n<p>如果事件处理函数有任何变化, 我们就从旧的节点中删除它</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">//Remove old or changed event listeners</span>\nObject<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isEvent<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>key <span class=\"token keyword\">in</span> nextProps<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">,</span> nextProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> eventType <span class=\"token operator\">=</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dom<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> prevProps<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>同时添加修改后的事件处理函数:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// Add event listeners</span>\nObject<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nextProps<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isEvent<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">,</span> nextProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> eventType <span class=\"token operator\">=</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    dom<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> nextProps<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>含有协调功能的 react 实现完整代码: <a href=\"https://github.com/icyfish/didact/blob/master/src/index_v2.jsx\">React With Reconcilation</a></p>\n<h2 id=\"函数式组件\" style=\"position:relative;\"><a href=\"#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6\" aria-label=\"函数式组件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>函数式组件</h2>\n<p>接下来我们要做的是支持函数组件.</p>\n<p>首先修改示例. 我们使用一个简单的函数式组件, 它返回一个 <code class=\"language-text\">h1</code> 元素.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">/** @jsx Didact.createElement */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Hi </span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>foo<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">)</span>\nDidact<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">)</span></code></pre></div>\n<p>将 jsx 转换成 js 的话, 就是这样:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Didact<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Hi \"</span><span class=\"token punctuation\">,</span>\n    props<span class=\"token punctuation\">.</span>name\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> Didact<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>App<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  name<span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>函数式组件在以下两个方面与普通组件有所区别:</p>\n<ul>\n<li>函数式组件的 fiber 不存在 DOM 节点.</li>\n<li>它的子元素的产生来自于函数式组件的执行, 而不是通过 <code class=\"language-text\">props</code> 传入</li>\n</ul>\n<p>在 <code class=\"language-text\">performUnitOfWork</code> 函数中, 我们检查 fiber 的类型是否是函数, 根据结果执行不同的更新操作.</p>\n<p>拆分出函数式组件的处理方法 <code class=\"language-text\">updateHostComponent</code> 和普通组件 的处理方法<code class=\"language-text\">updateHostComponent</code>.</p>\n<p><code class=\"language-text\">updateHostComponent</code> 所做的工作与原来一致:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> <span class=\"token function\">createDom</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 <code class=\"language-text\">updateFunctionComponent</code> 中, 我们执行这个函数组件以获取子元素. </p>\n<p>在我们的例子中, <code class=\"language-text\">fiber.type</code> 的值为 <code class=\"language-text\">App</code> 函数, 执行它时, 会返回 <code class=\"language-text\">h1</code> 元素.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>fiber<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>获取到子元素之后, 协调的工作还是和前一个版本没有区别, 因此不需要做出修改.</p>\n<p>接下来需要修改的是 <code class=\"language-text\">commitWork</code> 函数.</p>\n<p>开始处理没有 DOM 节点属性的 fibers, 需要修改两处:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"PLACEMENT\"</span> <span class=\"token operator\">&amp;&amp;</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"UPDATE\"</span> <span class=\"token operator\">&amp;&amp;</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">updateDom</span><span class=\"token punctuation\">(</span>\n      fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span>\n      fiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n      fiber<span class=\"token punctuation\">.</span>props\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"DELETION\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>首先要找到 DOM 节点的父节点, 在 fiber 树中不断向上寻找直到找到一个存在 DOM 节点的 fiber.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">let</span> domParentFiber <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>domParentFiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParentFiber <span class=\"token operator\">=</span> domParentFiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> domParentFiber<span class=\"token punctuation\">.</span>dom\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"PLACEMENT\"</span> <span class=\"token operator\">&amp;&amp;</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>删除节点也是, 需要不断寻找知道找到存在 DOM 节点的 fiber.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom\n   <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>xxx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// xxx</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"DELETION\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber<span class=\"token punctuation\">,</span> domParent</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">,</span> domParent<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"hooks\" style=\"position:relative;\"><a href=\"#hooks\" aria-label=\"hooks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hooks</h2>\n<p>最后一步是实现为函数式组件添加状态. </p>\n<p>现在我们将 app 示例进行修改, 改为一个比较经典的计数器应用. 每一次点击计数器的数值就会加上1. </p>\n<p>我们使用 <code class=\"language-text\">Didact.useState</code> 来读取和更新计数器的值.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">/** @jsx Didact.createElement */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> Didact<span class=\"token punctuation\">.</span><span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> c <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      Count: </span><span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Counter</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>接下来开始实现 <code class=\"language-text\">useState</code> 方法.</p>\n<p>在调用函数式组件之前, 我们需要初始化一些全局变量, 然后在 <code class=\"language-text\">useState</code> 方法中使用它们.</p>\n<p>首先我们设置正在工作的 fiber (<code class=\"language-text\">wipFiber</code>). </p>\n<p>为这个 filber 设置 <code class=\"language-text\">hooks</code> 属性以支持 <code class=\"language-text\">useState</code> 在同一个组件中多次被调用, 由于被调用多次, 我们还需要关注当前的 hook 索引.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">let</span> wipFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> hookIndex <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  wipFiber <span class=\"token operator\">=</span> fiber\n  hookIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  wipFiber<span class=\"token punctuation\">.</span>hooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>fiber<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当函数式组件调用 <code class=\"language-text\">useState</code> 时, 我们会检查是否有一个旧的 hook 存在. 通过 fiber 的 <code class=\"language-text\">alternate</code> 和 hook 索引得到我们想要的结果.</p>\n<p>如果存在一个旧的 hook, 那么我们就会将旧 hook 所存储的 state 拷贝到新的 hook 中. 如果不存在的话, 则初始化一个 state.</p>\n<p>然后添加新的 hook 到 fiber 中, index 加上1, 然后返回这个 state.</p>\n<p><code class=\"language-text\">useState</code> 同时还需要返回一个函数, 用以更新 state. 于是我们定义一个 <code class=\"language-text\">setState</code> 方法. 接受一个 action 作为参数, 在计数器的例子中, 这个 action 是每次点击为数字的值增加1.</p>\n<p>我们给 <code class=\"language-text\">hook</code> 添加一个 队列 <code class=\"language-text\">queue</code> 属性, 每次用户调用 <code class=\"language-text\">setState</code>, 就把这个 action 添加到队列中.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">setState</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  hook<span class=\"token punctuation\">.</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  wipRoot <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    dom<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n    alternate<span class=\"token operator\">:</span> currentRoot\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  nextUnitOfWork <span class=\"token operator\">=</span> wipRoot<span class=\"token punctuation\">;</span>\n  deletions <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>将这个 action 添加到 <code class=\"language-text\">hook</code> 的属性 <code class=\"language-text\">queue</code> 中.</p>\n<p>接下来做一些与在 <code class=\"language-text\">render</code> 函数中类似的事情. 设置一个新的追踪节点(<code class=\"language-text\">wipRoot</code>), 在下一次工作进程开始时, 循环中可以开始一次新的渲染流程.</p>\n<p>接下来是执行 action, 在下一次组件重新渲染时, 我们会从旧的 hook 队列中读取到所有 action. 之后我们会在新的 hook 状态中一一执行这些 action, 然后返回最新的状态.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">initial</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> oldHook <span class=\"token operator\">=</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">&amp;&amp;</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>hooks <span class=\"token operator\">&amp;&amp;</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">[</span>hookIndex<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    state<span class=\"token operator\">:</span> oldHook <span class=\"token operator\">?</span> oldHook<span class=\"token punctuation\">.</span>state <span class=\"token operator\">:</span> initial<span class=\"token punctuation\">,</span>\n    queue<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">const</span> actions <span class=\"token operator\">=</span> oldHook <span class=\"token operator\">?</span> oldHook<span class=\"token punctuation\">.</span>queue <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  actions<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    hook<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token function\">action</span><span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">setState</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    hook<span class=\"token punctuation\">.</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    wipRoot <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span>\n      props<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n      alternate<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> wipRoot\n    deletions <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n\n  wipFiber<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">)</span>\n  hookIndex<span class=\"token operator\">++</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>hook<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最终版本的代码: <a href=\"https://codesandbox.io/s/didact-8-21ost\">React With Hooks</a></p>\n<h2 id=\"后记\" style=\"position:relative;\"><a href=\"#%E5%90%8E%E8%AE%B0\" aria-label=\"后记 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>后记</h2>\n<p>这篇文章除了帮助大家理解 React 的实现原理之外, 还有一个目的就是希望大家在阅读完之后能更容易地探索 React 源码. 这也是我们在文章中使用与源码一致的变量名和函数名的原因.</p>\n<p>举个例子, 如果你在实际的 React 应用中, 在函数式组件里添加断点, 调用栈就会是如下这样:</p>\n<ul>\n<li><code class=\"language-text\">workLoop</code></li>\n<li><code class=\"language-text\">performUnitOfWork</code></li>\n<li><code class=\"language-text\">updateFunctionComponent</code></li>\n</ul>\n<p>当然, 教程中并没有覆盖到全部的 React 特性以及优化点. 举个例子, 下面是 React 与我们的源码实现地不同的地方:</p>\n<ul>\n<li>在 Didact 中, 我们在 <code class=\"language-text\">render</code> 阶段遍历了整个树. 而 React 并不会这样做, 当子树没有任何变化的话, 某些不必要的渲染流程就会被跳过.</li>\n<li>同时在提交阶段, 我们也遍历了整个树, 而 React 则是维护了一个链表, 只关注有 <code class=\"language-text\">effectTag</code> 的 fiber, 只遍历这些 fiber.</li>\n<li>每次我们创建一个新的工作节点时, 都会在每个 fiber 中创建新的对象. 而 React 则会从先前的树中回收这些 fiber.</li>\n<li>当 Didact 在 <code class=\"language-text\">render</code> 阶段执行一次更新时, 会将追踪工作树完全移除, 然后从根节点再重新开始流程. 而 React 的每一个 tag 则是维护了一个时间戳, 根据是否超时来确定此次更新的优先级.</li>\n<li>以及更多…</li>\n</ul>\n<p>你还可以很方便地添加 React 相关的其他特性:</p>\n<ul>\n<li>处理值为对象的 <code class=\"language-text\">style</code> 属性</li>\n<li><a href=\"https://github.com/pomber/didact/issues/11\">实现子元素的扁平化</a></li>\n<li><code class=\"language-text\">useEffect</code></li>\n<li>根据 key 进行协调</li>\n</ul>","headings":[{"value":"概览","id":"概览","depth":2},{"value":"实现 createElement 函数","id":"实现-createelement-函数","depth":2},{"value":"实现 render 方法","id":"实现-render-方法","depth":2},{"value":"实现 Concurrent 模式","id":"实现-concurrent-模式","depth":2},{"value":"Fibers","id":"fibers","depth":2},{"value":"渲染与提交阶段 Commit","id":"渲染与提交阶段-commit","depth":2},{"value":"协调 Reconciliation","id":"协调-reconciliation","depth":2},{"value":"函数式组件","id":"函数式组件","depth":2},{"value":"Hooks","id":"hooks","depth":2},{"value":"后记","id":"后记","depth":2}],"frontmatter":{"title":"实现自己的 React","date":"December 25, 2020","description":"Build Your Own React","draft":false}},"previous":{"fields":{"slug":"/how-does-setstate-know-what-to-do/"},"frontmatter":{"title":"setState如何知道自己应该做什么?"}},"next":{"fields":{"slug":"/usedelegate-hook/"},"frontmatter":{"title":"实现一个事件委托 hook"}}},"pageContext":{"id":"87a8465c-204d-5bcf-a903-7fca9c8a4fd0","previousPostId":"7feec3b7-055c-5703-88d1-9b0c4949d166","nextPostId":"8cc0ec57-59a5-5eaf-83d8-bf3a92cfd410"}},"staticQueryHashes":["2841359383","3257411868"]}