{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/usedelegate-hook/","result":{"data":{"markdownRemark":{"id":"9ee48feb-41e8-53f0-85c0-c73f151f027c","html":"<h2 id=\"背景\" style=\"position:relative;\"><a href=\"#%E8%83%8C%E6%99%AF\" aria-label=\"背景 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>背景</h2>\n<p>我们的业务场景是一个页面搭建平台, 平台中存在许多固定模板用以搭建页面. 其中有一个比较特殊的模板叫做自定义代码模板, 通过这个模板, 用户能够在后台录入一些 html 以供前端页面读取, 并渲染对应的内容. 关于这个模板的主要功能逻辑, 在这篇文章中已经做出了介绍: <a href=\"http://icyfish.github.io/blog/posts/ssr-render-html-string/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">在 React 组件中渲染接口下发的 html</a></p>\n<p>对于这个模板的功能, 我们还需要做出一些优化. 在正常情况下, 运营编写自定义代码的最主要诉求为以下两类:</p>\n<ol>\n<li>添加花哨的页面动效, 以营造营销活动的氛围(这部分主要依赖外部 JavaScript 的引入, 在主要功能介绍的文章中, 我们针对这个诉求已经做出了一些特殊的处理 .</li>\n<li>第二点则是针对自定义代码中的某些元素添加点击事件, 跳转到二级页面, 以达到引流的目的.</li>\n</ol>\n<p>但是由于我们的页面需要适应不同的平台, H5, App, 微信小程序等, 因此点击方法的实现也需要根据平台有所差异, 用户不可能也没有必要去实现这些差异化的处理. 针对这部分内容, 我们也在程序中实现了特殊的处理. </p>\n<p>首先我们和用户约定, 在需要添加点击事件的 DOM 元素中, 用户要给这个元素添加一个特殊的类名, 我们约定为 <code class=\"language-text\">.moreLink</code> , 同时在这个 DOM 元素上还需要添加点击的目标 URL. URL 是区分平台的, 因此约定了三个属性: <code class=\"language-text\">data-url</code> , <code class=\"language-text\">data-appurl</code> , <code class=\"language-text\">data-miniprogramurl</code> .</p>\n<p>这样的话, 我们接受到的自定义 html 字符串就可能是如下这样的:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> codeBlock <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n&lt;div data-url=\"https://m.ctrip.com\" class=\"moreLink\">&lt;h1>outer&lt;/h1>&lt;/div>\n&lt;div>&lt;h1 data-url=\"https://m.ctrip.com\" class=\"moreLink\">inner&lt;/h1>&lt;/div>\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> codeBlock <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"功能实现\" style=\"position:relative;\"><a href=\"#%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0\" aria-label=\"功能实现 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>功能实现</h2>\n<h3 id=\"target-和-currenttarget\" style=\"position:relative;\"><a href=\"#target-%E5%92%8C-currenttarget\" aria-label=\"target 和 currenttarget permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>target 和 currentTarget</h3>\n<p>在开始处理这个需求之前, 我们先确定一下事件处理器相关的两个概念, <code class=\"language-text\">event.target</code> 和 <code class=\"language-text\">event.currentTarget</code>.  其中 <code class=\"language-text\">target</code> 表示触发点击事件的元素, <code class=\"language-text\">currentTarget</code> 表示绑定了事件处理器的元素. 这样看来, 在我们的场景下, <code class=\"language-text\">target</code> 才是有意义的.</p>\n<p>那么是不是直接针对 <code class=\"language-text\">target</code> 绑定点击事件就可以了呢? 实际情况并不是这样. 根据背景中给出的示例 html, 以下是对应的 DOM 元素和点击所输出的内容.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/227359a3dc64bc9ed512ecd4df136238/01a87/log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 16.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlUlEQVQI1z2OyRLDIAxD8/9f2Wk7kAVoUtawRLUO6eGNkY1lTa017G6HtQ6HO1BKQTlPxJQQYkSmFpLoKJrwzV7vHdd1YYzxZ2q1wc4rjHpgnTUW9YGZd6iXgX4bfDeNbdnwfFootUIrDbc4hBCQc0atFQx1m09VDO/rrJ14jyF6BI8uS0mgAeenpGc6auLlL3fZo+EPxGbnirXRhCwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/227359a3dc64bc9ed512ecd4df136238/8ac56/log.webp 240w,\n/blog/static/227359a3dc64bc9ed512ecd4df136238/d3be9/log.webp 480w,\n/blog/static/227359a3dc64bc9ed512ecd4df136238/e46b2/log.webp 960w,\n/blog/static/227359a3dc64bc9ed512ecd4df136238/6f638/log.webp 1288w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/227359a3dc64bc9ed512ecd4df136238/8ff5a/log.png 240w,\n/blog/static/227359a3dc64bc9ed512ecd4df136238/e85cb/log.png 480w,\n/blog/static/227359a3dc64bc9ed512ecd4df136238/d9199/log.png 960w,\n/blog/static/227359a3dc64bc9ed512ecd4df136238/01a87/log.png 1288w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/227359a3dc64bc9ed512ecd4df136238/d9199/log.png\"\n            alt=\"log\"\n            title=\"log\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>生成的 DOM 元素</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 924px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/dfac59994404a96fdcd1346e8b3028cd/9a1cf/html.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.916666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAv0lEQVQY062PV27EMAwFff8jBvlYxI6brOoiq3hnGS9ygSAEBmwPxGPjJofrFOrrA9M/hIm2DfTDyjhtTMI4brTdyuY9YRSN0nffdoFFrVy1UMqbJh+J5XNmWQzerxzm4Hld/DUaPzp853jWJGQ5Vkipcp6VnK+7/qXkSk1Rcrr3Mb7nOWfJiZJ+HMaEeWjWuWXXAzE4cXvImwfanGh9olRkFkI45YOe3WqmOTIMO8ZErLWiNWxqo7FyzH87/ite+WKD0HEB+4wAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/dfac59994404a96fdcd1346e8b3028cd/8ac56/html.webp 240w,\n/blog/static/dfac59994404a96fdcd1346e8b3028cd/d3be9/html.webp 480w,\n/blog/static/dfac59994404a96fdcd1346e8b3028cd/c3b05/html.webp 924w\"\n              sizes=\"(max-width: 924px) 100vw, 924px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/dfac59994404a96fdcd1346e8b3028cd/8ff5a/html.png 240w,\n/blog/static/dfac59994404a96fdcd1346e8b3028cd/e85cb/html.png 480w,\n/blog/static/dfac59994404a96fdcd1346e8b3028cd/9a1cf/html.png 924w\"\n            sizes=\"(max-width: 924px) 100vw, 924px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/dfac59994404a96fdcd1346e8b3028cd/9a1cf/html.png\"\n            alt=\"dom\"\n            title=\"dom\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>点击输出的内容</p>\n<p>会发现, inner 的点击结果是我们所预期的, 但是 outer 的结果, 并不是. 令人难过的是, outer 的场景, 在实际情况下出现的概率很高. 因此我们不能简单地使用 <code class=\"language-text\">target</code> 来实现这个需求.</p>\n<h3 id=\"找到约定的目标元素\" style=\"position:relative;\"><a href=\"#%E6%89%BE%E5%88%B0%E7%BA%A6%E5%AE%9A%E7%9A%84%E7%9B%AE%E6%A0%87%E5%85%83%E7%B4%A0\" aria-label=\"找到约定的目标元素 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>找到约定的目标元素</h3>\n<p>从以上例子中可以看出来, 通过 <code class=\"language-text\">.moreLink</code> 找到所有需要被绑定点击事件的元素(后面称之为 <code class=\"language-text\">.moreLink</code> 元素)之后, 我们要对比<code class=\"language-text\">.moreLink</code>元素与 <code class=\"language-text\">event.target</code> 的关系, 如果两者一致, 或者<code class=\"language-text\">.moreLink</code>元素是 <code class=\"language-text\">event.target</code> 的父元素, 那么我们就给这个 <code class=\"language-text\">.moreLink</code> 绑定上事件处理器.</p>\n<p>接下来开始实现, 由于我们做的事情跟事件委托很相似, 因此我们把实现这部分功能的 hook 命名为: <code class=\"language-text\">useDelegateEvent</code> </p>\n<h3 id=\"usedelegateevent\" style=\"position:relative;\"><a href=\"#usedelegateevent\" aria-label=\"usedelegateevent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>useDelegateEvent</h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> useEffect<span class=\"token punctuation\">,</span> useRef <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">useDelegateEvent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> selector<span class=\"token punctuation\">,</span> handler</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> ref <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> ref<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>element<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">handleEvent</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> targetNode <span class=\"token operator\">=</span> <span class=\"token function\">getTargetNode</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">,</span> selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>targetNode<span class=\"token punctuation\">)</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">,</span> targetNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    element<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">,</span> handleEvent<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      element<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">,</span> handleEvent<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">,</span> selector<span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> ref<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> useDelegateEvent<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getTargetNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">container<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">,</span> selector</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> elemList <span class=\"token operator\">=</span> container<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span>selector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> targetNode <span class=\"token operator\">=</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>elemList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">elem</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">isDescendant</span><span class=\"token punctuation\">(</span>elem<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> targetNode<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isDescendant</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> child</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parent <span class=\"token operator\">===</span> child<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> node <span class=\"token operator\">=</span> child<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">===</span> parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">CustomCode</code> 组件:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> useMemo <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> useAttachScript <span class=\"token keyword\">from</span> <span class=\"token string\">\"../hooks/useAttachScript\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> useDelegateEvent <span class=\"token keyword\">from</span> <span class=\"token string\">\"../hooks/useDelegateEvent\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> separateScript <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"../utils\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * 由于客户端渲染的情况下使用  dangerouslySetInnerHTML 渲染的 script 标签中的代码无法执行\n * 因此需要分离 html 与 script\n */</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">CustomCode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> codeBlock <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>scriptStrList<span class=\"token punctuation\">,</span> markup<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">separateScript</span><span class=\"token punctuation\">(</span>codeBlock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>codeBlock<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> eventType <span class=\"token operator\">=</span> <span class=\"token string\">\"click\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> selector <span class=\"token operator\">=</span> <span class=\"token string\">\".moreLink\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> ref <span class=\"token operator\">=</span> <span class=\"token function\">useDelegateEvent</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> selector<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e<span class=\"token punctuation\">,</span> targetNode</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">let</span> clickLinkHttp <span class=\"token operator\">=</span> targetNode<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data-url\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> clickLinkApp <span class=\"token operator\">=</span> targetNode<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data-appurl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> clickLinkMiniProgram <span class=\"token operator\">=</span> targetNode<span class=\"token punctuation\">.</span><span class=\"token function\">getAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data-miniprogramurl\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">handleClick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      clickLinkHttp<span class=\"token punctuation\">,</span>\n      clickLinkApp<span class=\"token punctuation\">,</span>\n      clickLinkMiniProgram\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">useAttachScript</span><span class=\"token punctuation\">(</span>scriptStrList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">dangerouslySetInnerHTML</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> __html<span class=\"token operator\">:</span> markup <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>ref<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleClick</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">options</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 针对多个链接区分平台的点击处理, 这里不展开</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>最终代码示例: <a href=\"https://github.com/icyfish/react-app/blob/master/src/hooks/useDelegateEvent.js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Github Repo</a></p>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/10086427/what-is-the-exact-difference-between-currenttarget-property-and-target-property\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">What is the exact difference between currentTarget property and target property in javascript</a></li>\n<li><a href=\"https://zh.javascript.info/event-delegation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">事件委托</a></li>\n</ul>","headings":[{"value":"背景","depth":2},{"value":"功能实现","depth":2},{"value":"target 和 currentTarget","depth":3},{"value":"找到约定的目标元素","depth":3},{"value":"useDelegateEvent","depth":3},{"value":"参考","depth":2}],"fields":{"slug":"/posts/usedelegate-hook/","tagSlugs":["/tag/hooks/"]},"frontmatter":{"date":"2021-04-19","description":"Implement A useDelegateEvent Hook","tags":["hooks"],"title":"实现一个事件委托 hook","socialImage":null}}},"pageContext":{"slug":"/posts/usedelegate-hook/"}},"staticQueryHashes":["251939775","401334301","825871152"]}