<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/blog/styles.2bd813a679a852f86223.css" id="gatsby-global-css">html{scroll-behavior:smooth;font-size:100}::-moz-selection{background-color:#42b983;color:#fff}::selection{background-color:#42b983;color:#fff}body{margin:0 0 0 calc(100vw - 100%);color:#2c3e50;line-height:1.6;font-size:.9375rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body,h1,h2,h3,h4,h5,h6{font-family:Source Sans Pro,Helvetica Neue,Arial,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:2.34375rem;line-height:3.25rem;margin-top:6.5rem;margin-bottom:1.625rem}h2{font-size:1.58203rem;line-height:2.4375rem}h2,h3{margin-top:3.25rem;margin-bottom:.8125rem}h3{font-size:1.28906rem;line-height:1.625rem}h4{font-size:1.125rem;margin-top:2.4375rem}h4,h5{line-height:1.625rem;margin-bottom:.8125rem}h5,h6{font-size:.9375rem;margin-top:4.0625rem}h6{line-height:1.625rem;margin-bottom:.8125rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#2c3e50;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#2c3e50 0,#2c3e50 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#42b983;text-decoration:none}a:active,a:focus,a:hover{color:#f7a046}b,strong{font-weight:600}ul{list-style:disc;margin-bottom:1.625rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.625rem;margin-bottom:1.625rem}blockquote{padding:0;font-style:italic;text-align:center}figure{display:block;width:100%;height:auto}figcaption{line-height:1.21875rem;margin-top:.40625rem;color:#2c3e50;font-size:.875rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.625rem}.float-right{float:right}.float-left{float:left}}@font-face{font-family:Roboto Mono;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vq_SeW-AJi8SJQtQ4Y.woff) format("woff");unicode-range:U+0460-052f,U+1c80-1c88,U+20b4,U+2de0-2dff,U+a640-a69f,U+fe2e-fe2f}@font-face{font-family:Roboto Mono;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vq_QOW-AJi8SJQtQ4Y.woff) format("woff");unicode-range:U+0400-045f,U+0490-0491,U+04b0-04b1,U+2116}@font-face{font-family:Roboto Mono;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vq_R-W-AJi8SJQtQ4Y.woff) format("woff");unicode-range:U+0370-03ff}@font-face{font-family:Roboto Mono;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vq_S-W-AJi8SJQtQ4Y.woff) format("woff");unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01a0-01a1,U+01af-01b0,U+1ea0-1ef9,U+20ab}@font-face{font-family:Roboto Mono;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vq_SuW-AJi8SJQtQ4Y.woff) format("woff");unicode-range:U+0100-024f,U+0259,U+1e??,U+2020,U+20a0-20ab,U+20ad-20cf,U+2113,U+2c60-2c7f,U+a720-a7ff}@font-face{font-family:Roboto Mono;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/robotomono/v13/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_3vq_ROW-AJi8SJQt.woff) format("woff");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwmhdu3cOWxy40.woff2) format("woff2");unicode-range:U+0460-052f,U+1c80-1c88,U+20b4,U+2de0-2dff,U+a640-a69f,U+fe2e-fe2f}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwkxdu3cOWxy40.woff2) format("woff2");unicode-range:U+0400-045f,U+0490-0491,U+04b0-04b1,U+2116}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwmxdu3cOWxy40.woff2) format("woff2");unicode-range:U+1f??}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwlBdu3cOWxy40.woff2) format("woff2");unicode-range:U+0370-03ff}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwmBdu3cOWxy40.woff2) format("woff2");unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01a0-01a1,U+01af-01b0,U+1ea0-1ef9,U+20ab}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwmRdu3cOWxy40.woff2) format("woff2");unicode-range:U+0100-024f,U+0259,U+1e??,U+2020,U+20a0-20ab,U+20ad-20cf,U+2113,U+2c60-2c7f,U+a720-a7ff}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3ik4zwlxdu3cOWxw.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNa7lujVj9_mf.woff2) format("woff2");unicode-range:U+0460-052f,U+1c80-1c88,U+20b4,U+2de0-2dff,U+a640-a69f,U+fe2e-fe2f}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qPK7lujVj9_mf.woff2) format("woff2");unicode-range:U+0400-045f,U+0490-0491,U+04b0-04b1,U+2116}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNK7lujVj9_mf.woff2) format("woff2");unicode-range:U+1f??}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qO67lujVj9_mf.woff2) format("woff2");unicode-range:U+0370-03ff}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qN67lujVj9_mf.woff2) format("woff2");unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01a0-01a1,U+01af-01b0,U+1ea0-1ef9,U+20ab}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNq7lujVj9_mf.woff2) format("woff2");unicode-range:U+0100-024f,U+0259,U+1e??,U+2020,U+20a0-20ab,U+20ad-20cf,U+2113,U+2c60-2c7f,U+a720-a7ff}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7lujVj9w.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwmhdu3cOWxy40.woff2) format("woff2");unicode-range:U+0460-052f,U+1c80-1c88,U+20b4,U+2de0-2dff,U+a640-a69f,U+fe2e-fe2f}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwkxdu3cOWxy40.woff2) format("woff2");unicode-range:U+0400-045f,U+0490-0491,U+04b0-04b1,U+2116}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwmxdu3cOWxy40.woff2) format("woff2");unicode-range:U+1f??}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwlBdu3cOWxy40.woff2) format("woff2");unicode-range:U+0370-03ff}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwmBdu3cOWxy40.woff2) format("woff2");unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01a0-01a1,U+01af-01b0,U+1ea0-1ef9,U+20ab}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwmRdu3cOWxy40.woff2) format("woff2");unicode-range:U+0100-024f,U+0259,U+1e??,U+2020,U+20a0-20ab,U+20ad-20cf,U+2113,U+2c60-2c7f,U+a720-a7ff}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwlxdu3cOWxw.woff2) format("woff2");unicode-range:U+00??,U+0131,U+0152-0153,U+02bb-02bc,U+02c6,U+02da,U+02dc,U+2000-206f,U+2074,U+20ac,U+2122,U+2191,U+2193,U+2212,U+2215,U+feff,U+fffd}code[class*=language-],pre[class*=language-]{color:#ddcaca;background:none;font-family:Consolas,Roboto Mono,Monaco,courier,monospace,Menlo,source-code-pro,Courier New,monospace;font-feature-settings:normal;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;margin-bottom:0;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{font-size:16px;margin:0 0 0 20px;padding:1.2rem 0}pre[class*=language-]::selection{background:#27292a}pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:hsla(0,0%,100%,.15)}:not(pre)>code[class*=language-]{border-radius:.3em;background:#f8f8f8;color:#d63200;padding:.15em .2em .05em;white-space:normal}.token.attr-name{color:#addb67;font-style:italic}.token.comment{color:#809393}.token.string,.token.url{color:#addb67}.token.variable{color:#d6deeb}.token.number{color:#f78c6c}.token.builtin,.token.char,.token.constant,.token.function{color:#82aaff}.token.punctuation{color:#c792ea}.token.doctype,.token.selector{color:#c792ea;font-style:"italic"}.token.class-name{color:#ffcb8b}.token.keyword,.token.operator,.token.tag{color:#ffa7c4}.token.boolean{color:#ff5874}.token.property{color:#80cbc4}.token.namespace{color:#b2ccd6}pre[data-line]{padding:1em 0 1em 3em;position:relative}.gatsby-highlight-code-line{background-color:#022a4b;display:block;padding-right:1em;padding-left:1.25em;border-left:.25em solid #ffa7c4}.gatsby-highlight,.gatsby-highlight-code-line{margin-right:-1.3125rem;margin-left:-1.3125rem}.gatsby-highlight{margin-bottom:1.75rem;border-radius:10px;background:#011627;-webkit-overflow-scrolling:touch;overflow:auto}@media (max-width:672px){.gatsby-highlight{border-radius:0}}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:1.05469rem;font-weight:600;line-height:1.82813rem;margin:.8125rem 0}.Author-module--author__title-link--Yrism,.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#2c3e50}.Author-module--author__subtitle--cAaEB{color:#8aa4be;line-height:1.625rem;margin-bottom:1.625rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.625rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #fff}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#2c3e50}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#42b983}.Copyright-module--copyright--1ariN{color:#c5d2df;font-size:.875rem}.Menu-module--menu--Efbin{margin-bottom:1.625rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:.9375rem;color:#2c3e50;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#42b983;border-bottom:1px solid #42b983}.Menu-module--menu__list-item-link--active--2CbUO{color:#2c3e50;border-bottom:1px solid #2c3e50}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#fff;background:linear-gradient(180deg,#fff 0,#fff 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:2.03125rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.8125rem}.Feed-module--feed__item-title--3nigr{font-size:1.58203rem;line-height:2.4375rem;margin-top:0;margin-bottom:.8125rem}.Feed-module--feed__item-title-link--iFMRs{color:#2c3e50}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#2c3e50;border-bottom:1px solid #2c3e50}.Feed-module--feed__item-description--1uO8e{font-size:.9375rem;line-height:1.625rem;margin-bottom:1.21875rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.875rem;color:#2c3e50;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.875rem;color:#f7a046;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#42b983}.Feed-module--feed__item-readmore--1u6bI{font-size:.9375rem;color:#42b983}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#42b983;border-bottom:1px solid #42b983}.Page-module--page--2nMky{margin-bottom:3.25rem}.Page-module--page__inner--2M_vz{margin-top:5rem;padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:2.34375rem;font-weight:600;line-height:3.25rem;margin-top:0;margin-bottom:2.35625rem}.Page-module--page__body--Ic6i6{font-size:.9375rem;line-height:1.625rem;margin:0 0 1.625rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:3.25rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#42b983}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#cbd7e3}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#42b983}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#cbd7e3}.Meta-module--meta--1XDVh{max-width:46.25rem;margin:0;flex:1 1}.Meta-module--meta__date--29eD7{font-weight:700}.Meta-module--meta__author--1D4TZ{color:#809393}.Tags-module--tags--1L_ct{margin-bottom:.8125rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem;border-radius:1.25rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;padding:0 .5rem;color:#fff;font-weight:700;background-color:#42b983;border-radius:.25rem;border-bottom:4px solid #3aa373}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#fff;text-decoration:underline}.Content-module--content--3p512{max-width:59.0625rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:1.875rem;max-width:46.25rem;font-weight:600;text-align:center;line-height:2.68125rem;margin:1.625rem auto 0}.Content-module--content__header--1CVRm{width:50rem}.Content-module--content__body--2TrQ- figure{margin-bottom:1.625rem;margin-top:3.75rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.625rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:46.25rem;font-size:1.57659rem;margin-top:0;margin-bottom:1.625rem;line-height:2.4375rem}.Content-module--content__body--2TrQ- *{max-width:46.25rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:1.875rem;line-height:3.65625rem;margin-top:3.65625rem;margin-bottom:2.4375rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:1.05469rem;line-height:1.82813rem;margin-bottom:1.82813rem}}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:46.25rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;float:left;max-width:11.875rem;height:2.1875rem;line-height:2.1875rem;text-align:center;color:#2c3e50;font-size:.9375rem;font-weight:400;margin-left:auto;margin-right:auto}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#42b983}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{color:#2c3e50;font-weight:700;font-size:1.5625rem}}</style><meta name="generator" content="Gatsby 2.32.13"/><link rel="alternate" type="application/rss+xml" title="A blog by Fish" href="/blog/rss.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-73379983-2"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-73379983-2', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/blog/sitemap.xml"/><link rel="icon" href="/blog/favicon-32x32.png?v=0d1ae485b869926285547d68f24089ad" type="image/png"/><link rel="manifest" href="/blog/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/blog/icons/icon-48x48.png?v=0d1ae485b869926285547d68f24089ad"/><link rel="apple-touch-icon" sizes="72x72" href="/blog/icons/icon-72x72.png?v=0d1ae485b869926285547d68f24089ad"/><link rel="apple-touch-icon" sizes="96x96" href="/blog/icons/icon-96x96.png?v=0d1ae485b869926285547d68f24089ad"/><link rel="apple-touch-icon" sizes="144x144" href="/blog/icons/icon-144x144.png?v=0d1ae485b869926285547d68f24089ad"/><link rel="apple-touch-icon" sizes="192x192" href="/blog/icons/icon-192x192.png?v=0d1ae485b869926285547d68f24089ad"/><link rel="apple-touch-icon" sizes="256x256" href="/blog/icons/icon-256x256.png?v=0d1ae485b869926285547d68f24089ad"/><link rel="apple-touch-icon" sizes="384x384" href="/blog/icons/icon-384x384.png?v=0d1ae485b869926285547d68f24089ad"/><link rel="apple-touch-icon" sizes="512x512" href="/blog/icons/icon-512x512.png?v=0d1ae485b869926285547d68f24089ad"/><title data-react-helmet="true">实现自己的 React - A blog by Fish</title><meta data-react-helmet="true" name="description" content="Build Your Own React"/><meta data-react-helmet="true" property="og:site_name" content="实现自己的 React - A blog by Fish"/><meta data-react-helmet="true" property="og:image" content="https://icyfish.github.io/photo.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="实现自己的 React - A blog by Fish"/><meta data-react-helmet="true" name="twitter:description" content="Build Your Own React"/><meta data-react-helmet="true" name="twitter:image" content="https://icyfish.github.io/photo.jpg"/><link as="script" rel="preload" href="/blog/webpack-runtime-c615a6c0065154c9a66f.js"/><link as="script" rel="preload" href="/blog/framework-1e331b2e9d55ebef6dec.js"/><link as="script" rel="preload" href="/blog/532a2f07-549094fa347c85980056.js"/><link as="script" rel="preload" href="/blog/dc6a8720040df98778fe970bf6c000a41750d3ae-5954f1f1c3eead9a6f74.js"/><link as="script" rel="preload" href="/blog/app-7bab443a509de4091087.js"/><link as="script" rel="preload" href="/blog/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/blog/cd95ea5cbd2c605f26db819f07999610c9ff4310-cb79b714c9287bd00e29.js"/><link as="script" rel="preload" href="/blog/component---src-templates-post-template-js-80973b30dfbf72fe7e5d.js"/><link as="fetch" rel="preload" href="/blog/page-data/posts/build-your-own-react/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/251939775.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/401334301.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/sq/d/825871152.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/blog/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><style data-emotion-css="o83204">.css-o83204{--tw-bg-opacity:1;background-color:rgba(255,255,255,var(--tw-bg-opacity));position:fixed;display:none;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;border-radius:0.25rem;padding:0.75rem;margin-top:0.75rem;margin-bottom:0.75rem;width:20rem;left:calc(50% + 400px);top:50px;}@media (min-width:1024px){.css-o83204{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}</style><ul class="css-o83204"><style data-emotion-css="1gx59eq">.css-1gx59eq{font-size:1.5rem;line-height:2rem;margin-bottom:0.5rem;}</style><h2 class="css-1gx59eq">Table of contents</h2><style data-emotion-css="1ogspyd">.css-1ogspyd{-webkit-scrollbar-width:thin;-moz-scrollbar-width:thin;-ms-scrollbar-width:thin;scrollbar-width:thin;-webkit-scrollbar-color:#367ee9 rgba(48,113,209,0.3);-moz-scrollbar-color:#367ee9 rgba(48,113,209,0.3);-ms-scrollbar-color:#367ee9 rgba(48,113,209,0.3);scrollbar-color:#367ee9 rgba(48,113,209,0.3);overflow:hidden auto;}</style><div class="css-1ogspyd"><style data-emotion-css="1dvi42b">.css-1dvi42b{padding:0.25rem;line-height:.75rem;margin-left:1rem;margin-bottom:1rem;margin-right:1rem;list-style-type:none;}</style><li class="css-1dvi42b"><style data-emotion-css="1y7cc89">.css-1y7cc89{-webkit-transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,-webkit-transform,filter,backdrop-filter;-webkit-transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;-webkit-transition-timing-function:cubic-bezier(0.4,0,0.2,1);transition-timing-function:cubic-bezier(0.4,0,0.2,1);-webkit-transition-duration:300ms;transition-duration:300ms;}</style><a href="#概览" class="css-1y7cc89">概览</a></li><li class="css-1dvi42b"><a href="#实现-createelement-函数" class="css-1y7cc89">实现 createElement 函数</a></li><li class="css-1dvi42b"><a href="#实现-render-方法" class="css-1y7cc89">实现 render 方法</a></li><li class="css-1dvi42b"><a href="#实现-concurrent-模式" class="css-1y7cc89">实现 Concurrent 模式</a></li><li class="css-1dvi42b"><a href="#fibers" class="css-1y7cc89">Fibers</a></li><li class="css-1dvi42b"><a href="#渲染与提交阶段-commit" class="css-1y7cc89">渲染与提交阶段 Commit</a></li><li class="css-1dvi42b"><a href="#协调-reconciliation" class="css-1y7cc89">协调 Reconciliation</a></li><li class="css-1dvi42b"><a href="#函数式组件" class="css-1y7cc89">函数式组件</a></li><li class="css-1dvi42b"><a href="#hooks" class="css-1y7cc89">Hooks</a></li><li class="css-1dvi42b"><a href="#后记" class="css-1y7cc89">后记</a></li></div></ul><div><a class="Post-module--post__home-button--16Kl0" href="/blog/">All Articles ✨</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">实现自己的 React</h1><div class="Content-module--content__body--2TrQ-"><div class="Content-module--content__header--1CVRm"><div class="Meta-module--meta--1XDVh"><p class="Meta-module--meta__date--29eD7">Published:<!-- --> <!-- -->Dec 25, 2020<!-- -->, <span class="Meta-module--meta__author--1D4TZ">By Fish</span></p></div></div><div><p>原文: <a href="https://pomb.us/build-your-own-react/" target="_blank" rel="nofollow noopener noreferrer">Build your own React</a></p>
<!-- ```toc
# This code block gets replaced with the TOC
``` -->
<p>这是一个从零开始实现 React 的教程，与生产版本有所差异的是，我们会忽略所有优化的细节，同时忽略一些与主要原理无关的特性。</p>
<p>也许你阅读过我之前写过的<a href="https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5" target="_blank" rel="nofollow noopener noreferrer">类似教程</a>，这篇教程与之前教程的区别是，本教程的源代码基于 React 16.8 版本，因此本教程包含了 hooks 的特性，同时不包含 class 版本组件的实现。</p>
<p>如果你同时希望学习旧版本的实现，可以查看旧版的教程以及与之相关的旧版<a href="https://github.com/pomber/didact" target="_blank" rel="nofollow noopener noreferrer">实现源码</a>。同时还有一个<a href="https://www.youtube.com/watch?v=8Kc2REHdwnQ&#x26;feature=youtu.be" target="_blank" rel="nofollow noopener noreferrer">视频解说</a>以供参考。不过阅读本教程并不强制要求你学习过之前的版本，本教程的内容是独立完整的。</p>
<p>我将实现过程拆分成了以下几个部分：</p>
<ol>
<li>实现 <code class="language-text">createElement</code> 函数</li>
<li>实现 <code class="language-text">render</code> 函数</li>
<li>Concurrent 模式</li>
<li>Fibers</li>
<li>渲染与提交阶段 (Commit)</li>
<li>协调 Reconciliation</li>
<li>函数式组件</li>
<li>Hooks</li>
</ol>
<h2 id="概览" style="position:relative;"><a href="#%E6%A6%82%E8%A7%88" aria-label="概览 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>概览</h2>
<p>首先我们来看几个基本概念。如果你对 React，JSX 和 DOM 元素的实现已经有了比较深刻的理解，可以跳过这部分的介绍直接进入下一部分。</p>
<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">Hello</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span></code></pre></div>
<p>这是一个简单的 React 应用，仅仅包含了三行代码。第一行定义了一个 React 元素。第二行利用 Web API 获取了 DOM 中的某一个节点，我将它称为容器。最后一行则是将我们的 React 元素插入到容器的操作。</p>
<p><strong>现在我们把所有 React 相关的代码全部替换为原生 JavaScript 代码。</strong></p>
<p>第一行代码，使用的是 JSX 语法，它并不是原生的 JavaScript 代码，因此我们对它做出一些修改：</p>
<div class="gatsby-highlight" data-language="tsx"><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">const</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">"h1"</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">"foo"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"Hello"</span>
<span class="token punctuation">)</span></code></pre></div>
<p>JSX 代码会被类似 Babel 的编译工具进行处理，转换成原生 JavaScript 代码。转换过程比较简单：将 <code class="language-text">&lt;</code> <code class="language-text">&gt;</code> 标签移除，使用 <code class="language-text">createElement</code> 函数调用进行替换，传入的参数分别为：标签名称，元素参数，以及元素的子元素。</p>
<p><code class="language-text">React.createElement</code> ，根据所传入的参数，创建了一个对象。除了一些有效性校验之外，整体的功能就是以上这样。因此我们可以直接把 JSX 替换成原生 JavaScript 的形式，人工确保元素和属性等的有效性。</p>
<p>经过以上处理之后，我们的元素就变成了这样的形式：一个对象，内部含有两个属性，分别是 <code class="language-text">type</code> 和 <code class="language-text">props</code> (当然了，实际上<a href="https://github.com/facebook/react/blob/f4cc45ce962adc9f307690e1d5cfa28a288418eb/packages/react/src/ReactElement.js#L111" target="_blank" rel="nofollow noopener noreferrer">包含更多</a>，目前我们只关注这两个就可以。）</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">type</code> 属性的值是字符串类型，表示我们所希望创建的 DOM 元素类型，相当于当你希望创建一个 HTML 元素的时候，传入 <code class="language-text">document.createElement</code> 函数中的标签名。当然除了字符串类型之外，<code class="language-text">type</code> 的值还可以是一个函数，这点我们会在函数式组件的那一部分中详细介绍。</p>
<p><code class="language-text">props</code> 是另一个对象，其中的内容包括所有 JSX 属性中的键值对。有一个特殊的属性需要特别关注，就是 <code class="language-text">children</code> 。</p>
<p>在我们当前的示例中，<code class="language-text">children</code> 的值是一个字符串，不过在大多数情况下，<code class="language-text">children</code> 的值会是一个包含很多元素的数组。这也是为什么, 元素的数据结构是树的原因。</p>
<p>我们的简易 React 应用中，第三行代码（<code class="language-text">ReactDOM.render</code>）也不是原生的 JavaScript 代码，同样需要进行转换。</p>
<p>在 <code class="language-text">render</code> 方法中，React 元素被转换并渲染到了 DOM 中，现在我们要用自己的方法去实现这一步。</p>
<p>首先需要做的是，利用第一步的 <code class="language-text">type</code> 属性，创建一个 DOM 节点，本例中我们的 <code class="language-text">type</code> 属性是 <code class="language-text">h1</code> 标签。</p>
<p>然后，我们将所有元素属性都赋到对应的 DOM 节点中。本例中只有 title 属性。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
node<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>title</code></pre></div>
<p>为了避免混淆，我会用“元素”来表示 React 元素，“节点”来表示 DOM 元素。</p>
<p>接下来要处理子元素所对应的节点了。本例中我们的子元素是文本，因此只需要创建一个文本节点即可。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> text <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
text<span class="token punctuation">[</span><span class="token string">"nodeValue"</span><span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children</code></pre></div>
<p>渲染文本节点使用的是 <code class="language-text">createTextNode</code> 而不是 <code class="language-text">innerText</code>, 可以保证在后续处理元素时, 所有元素的形式都是一致的, 抹平差异, 统一处理. 使用 <code class="language-text">createTextNode</code> 时, 文本也是属性, key 为 <code class="language-text">nodeValue</code> ，与之前针对 <code class="language-text">h1</code> 的处理是类似的：<code class="language-text">props: {nodeValue: &quot;hello&quot;}</code> </p>
<p>最后将 <code class="language-text">textNode</code> 添加到 <code class="language-text">h1</code> ，将 <code class="language-text">h1</code> 添加到容器中。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">"h1"</span><span class="token punctuation">,</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token string">"Hello"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
node<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>title

<span class="token keyword">const</span> text <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
text<span class="token punctuation">[</span><span class="token string">"nodeValue"</span><span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children

node<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></code></pre></div>
<p>至此，我们实现了与之前一致的应用，并且没有使用任何与 React 相关的代码。</p>
<h2 id="实现-createelement-函数" style="position:relative;"><a href="#%E5%AE%9E%E7%8E%B0-createelement-%E5%87%BD%E6%95%B0" aria-label="实现 createelement 函数 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现 createElement 函数</h2>
<p>现在我们开始实现另一个应用。这次将 React 相关的代码替换成我们自己版本的 React。</p>
<p>首先开始实现我们的 <code class="language-text">createElement</code> 。</p>
<p>还是先将 JSX 转换成 JS，以便看到 <code class="language-text">createElement</code> 函数调用。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span><span class="token plain-text">bar</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token punctuation">/></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span></code></pre></div>
<p>在之前的步骤中我们知道了：元素就是一个对象，内含有 <code class="language-text">type</code> 和 <code class="language-text">props</code> 属性。因此我们的 <code class="language-text">createElement</code> 函数需要做的就是创建这个元素对象。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>props<span class="token punctuation">,</span>
      children<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>我们使用  ES6 中的展开操作符来处理 <code class="language-text">props</code> 属性，剩余参数语法来处理 <code class="language-text">children</code> 属性，这样的话 <code class="language-text">children</code> 属性就始终是一个数组。</p>
<p>举个例子，<code class="language-text">createElement(&quot;div&quot;)</code> 函数返回的内容是：</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"div"</span><span class="token punctuation">,</span>
  <span class="token property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">createElement(&quot;div&quot;, null, a)</code> 函数返回的内容是：</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"div"</span><span class="token punctuation">,</span>
  <span class="token property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">createElement(&quot;div&quot;, null, a, b)</code> 函数返回的内容是：</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"div"</span><span class="token punctuation">,</span>
  <span class="token property">"props"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"children"</span><span class="token operator">:</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">children</code> 数组的内容还可以是原始类型的值，字符串或者数字。现在我们将所有非对象类型的元素用一个特殊的类型 <code class="language-text">TEXT_ELEMENT</code> 来表示。</p>
<p>在没有 <code class="language-text">children</code> 的情况下，React 不会封装原始类型的值或者是创建一个空数组，我们这样做的原因是为了简化代码，毕竟简单的代码更利于教学。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>props<span class="token punctuation">,</span>
      children<span class="token operator">:</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=></span>
        <span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">"object"</span>
          <span class="token operator">?</span> child
          <span class="token operator">:</span> <span class="token function">createTextElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createTextElement</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">"TEXT_ELEMENT"</span><span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      nodeValue<span class="token operator">:</span> text<span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">"div"</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">"foo"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"bar"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span></code></pre></div>
<p>目前我们依然在用 React 的 <code class="language-text">createElement</code> 。</p>
<p>现在给我们自己的库起个名字，来替换它。为了体现它的教学意义，又保持与 React 的名字类似，我们将这个库叫做 Didact 。</p>
<p>不过我还是想要使用 JSX 语法，因此我们需要告诉 babel，去使用 Didact 的 <code class="language-text">createElement</code> 而不是 React 的 <code class="language-text">createElement</code> 。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Didact <span class="token operator">=</span> <span class="token punctuation">{</span>
  createElement<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> element <span class="token operator">=</span> Didact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">"div"</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">"foo"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  Didact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"bar"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Didact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>只需要简单地加上这个注释，就能够达到我们的目的了：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token comment">/** @jsx Didact.createElement */</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span><span class="token plain-text">bar</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token punctuation">/></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span></code></pre></div>
<h2 id="实现-render-方法" style="position:relative;"><a href="#%E5%AE%9E%E7%8E%B0-render-%E6%96%B9%E6%B3%95" aria-label="实现 render 方法 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现 render 方法</h2>
<p>接下来我们要开始实现自己的 <code class="language-text">ReactDOM.render</code> 函数。</p>
<p>目前，我们只需要关注在 DOM 中添加内容即可。元素的更新和删除都在后续的章节中进行阐述。</p>
<p>首先使用元素的类型创建 DOM 节点，然后将所创建的节点添加到我们的容器中。</p>
<p>针对所有的 <code class="language-text">children</code> 都要去递归地处理。</p>
<p>与此同时还要处理文本类型的元素，创建文本节点而非普通节点。</p>
<p>最后将元素的属性都添加到 node 节点中。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dom <span class="token operator">=</span>
    element<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"TEXT_ELEMENT"</span>
      <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">isProperty</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span> key <span class="token operator">!==</span> <span class="token string">"children"</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=></span>
    <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dom<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>以上整体代码见：<a href="https://codesandbox.io/s/didact-2-k6rbj" target="_blank" rel="nofollow noopener noreferrer">React</a>.</p>
<h2 id="实现-concurrent-模式" style="position:relative;"><a href="#%E5%AE%9E%E7%8E%B0-concurrent-%E6%A8%A1%E5%BC%8F" aria-label="实现 concurrent 模式 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现 Concurrent 模式</h2>
<p>在开始实现 Concurrent 模式之前要对我们的代码进行重构。</p>
<p>之前版本的递归调用有一点问题:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx">element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=></span>
  <span class="token function">render</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> dom<span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>一旦组件开始进行渲染的进程，只有等全部的组件树渲染完毕后渲染流程才会结束。如果组件树过大的话，会长时间阻碍主进程。当浏览器要执行优先级高的操作（比如处理用户输入或者动画时），都需要等待渲染的结束，对性能造成比较大的影响。</p>
<p>因此我们要将渲染的流程拆分成一个个小的单元，在各个单元之间，我们可以暂停渲染进程，允许浏览器执行其他操作。</p>
<p>我们使用 <code class="language-text">[requestIdleCallback](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback)</code> (浏览器提供的一个 API )来创建一个循环。为了便于理解可以将 <code class="language-text">requestIdleCallback</code> 看作是 <code class="language-text">setTimeout</code>，区别就是，<code class="language-text">setTimeout</code> 受时间控制，而 <code class="language-text">requestIdleCallback</code>  则是在主进程处于空闲的情况下被浏览器执行的。</p>
<p>现在 <a href="https://github.com/facebook/react/issues/11171#issuecomment-417349573" target="_blank" rel="nofollow noopener noreferrer">React 已经不再使用</a> <code class="language-text">requestIdleCallback</code> 了，目前它的替代方案是 <a href="https://github.com/facebook/react/tree/master/packages/scheduler" target="_blank" rel="nofollow noopener noreferrer">scheduler</a> 包。不过两者所实现的主要功能相差无几。</p>
<p><code class="language-text">requestIdleCallback</code> 还接受一个类似最后期限 （deadline）的参数。我们可以利用这个参数知道浏览器还有多长时间之后, 会重新获取控制权。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 停止操作的 flag</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>
      nextUnitOfWork
    <span class="token punctuation">)</span>
    shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
  <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">nextUnitOfWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO</span>
<span class="token punctuation">}</span></code></pre></div>
<p>截止本文撰写的时间（2019年11月），Concurrent 模式在 React 中还并非稳定特性，处于实验阶段。稳定版本的循环代码大概像是下面这样：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
  nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>   
    nextUnitOfWork  
  <span class="token punctuation">)</span> 
<span class="token punctuation">}</span></code></pre></div>
<p>要想开始这段循环 (workLoop)，首先要设置首个单元的进程，然后实现 <code class="language-text">performUnitOfWork</code> 函数，处理当前单元的渲染进程，并返回下一个单元的进程。</p>
<h2 id="fibers" style="position:relative;"><a href="#fibers" aria-label="fibers permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fibers</h2>
<p>想要组织渲染进程的各个单元，我们需要依赖的数据结构是 fiber 树。</p>
<p>一个 fiber 代表每一个元素，而每一个 fiber 也是进程的一个单元。</p>
<p>下面看这个例子。</p>
<p>假设我们需要渲染的元素类似如下这样, 他的 fiber 树就如右图.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx">Didact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token punctuation">/></span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">,</span>
  container
<span class="token punctuation">)</span></code></pre></div>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 774px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/blog/static/d7e94c6d4027b55b401a631461f32b5b/41d3b/fiber.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 100.83333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACV0lEQVQ4y4VU53qbMBT1a8S1GUITMB6YeNtJs5o0jZu+/7ucXglDwPH4oQ8NdHTGlTo+kzjVvFBcHJ9rnUtgPT/CD4+hH/DG/PfmhfLQPwNYbTbJEMPxFJq+1SF2s229QKLrK3hMNkAvAFp2i/UOr+97TIp5zVJwDiE48pThbuwjZBz9sAIV5wCFO9nzGQYDCak1AZYMtZEw1JZTibetonVTr7UYtk0X6NGpsYqwLAxMmhLjkqE0MVQcY/cwx9PvLebLyXfAZgiVtD55JKIAWrJajp0P9RCBzpBsfiF9/IRZvyCIdL3eqTo2zflyg4xCsH0/UljeP+D59R3Z7Yx8Em0Vh8QDYVoKa8ndfoinl1cU86XrBwSYEnhezKCzkdscctVI++vb7NeAVupqc0f+ZK7vysAPMBlJKKMJTOJ2ltFBsuXZsf+15G6fYb27x3g6K4s5VEgU2ZArqCShOY5IKozz1IFWzI6Z1gxvSObH339YrLa46QVUNorqTSCOjZNfFS8TyrG1eyJZrrUYNiXf/XykEhm6tD0CWND44fkNybRwm1gygSo28GWC2W6HP/tPTFbrujJqydUJpXdfEiKhkWYDYlJ62CzwkGvnd0gpnwzluLDtdYoihlmuiXXs5ovbDEKVoPb/YwKXb0pgbwpDnglwbQ43RWA4Shzbq4CnXhtOqZqEUuWHUCioUMZOrg1DxgO3djKUU6/NiIr8+WMPkWbwSCYf5FDTNXwRQw9HeNnvYUZ0l31+HdCdSi04hOXmrMQgKmvu4KPXenyvvNgeE988av13wv//qII+XE5so/UAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <picture>
          <source
              srcset="/blog/static/d7e94c6d4027b55b401a631461f32b5b/8ac56/fiber.webp 240w,
/blog/static/d7e94c6d4027b55b401a631461f32b5b/d3be9/fiber.webp 480w,
/blog/static/d7e94c6d4027b55b401a631461f32b5b/9b58d/fiber.webp 774w"
              sizes="(max-width: 774px) 100vw, 774px"
              type="image/webp"
            />
          <source
            srcset="/blog/static/d7e94c6d4027b55b401a631461f32b5b/8ff5a/fiber.png 240w,
/blog/static/d7e94c6d4027b55b401a631461f32b5b/e85cb/fiber.png 480w,
/blog/static/d7e94c6d4027b55b401a631461f32b5b/41d3b/fiber.png 774w"
            sizes="(max-width: 774px) 100vw, 774px"
            type="image/png"
          />
          <img
            class="gatsby-resp-image-image"
            src="/blog/static/d7e94c6d4027b55b401a631461f32b5b/41d3b/fiber.png"
            alt="fiber"
            title="fiber"
            loading="lazy"
            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
          />
        </picture>
  </a>
    </span></p>
<p>在 <code class="language-text">render</code> 方法中， 我们会创建一个根 fiber, 然后将其设置为 <code class="language-text">nextUnitOfWork</code> (下一个执行单元）。之后的流程则在 <code class="language-text">performUnitOfWork</code> (执行当前工作单元)函数中实现，在这个函数中，我们会针对每一个 fiber 执行如下操作：</p>
<ol>
<li>将元素添加到 DOM 中</li>
<li>为元素的子元素创建各自的 fiber</li>
<li>返回下一个执行单元(需要被处理的 fiber)</li>
</ol>
<p>我们选择 fiber 数据结构的原因是便于找到下一个执行单元。这也是为什么每一个 fiber 都与它的第一个子节点，相邻的兄弟节点和父节点都存在关联关系的原因。</p>
<p>当我们在<code class="language-text">performUnitOfWork</code> 中做好处理 fiber 的任务之后,  如果这个 fiber 有一个 <code class="language-text">child</code> 子节点，那么这个子节点对应的 fiber 就是下一个执行单元。</p>
<p>在我们的示例中，<code class="language-text">h1</code> 是 <code class="language-text">div</code> 之后的一个执行单元 。</p>
<p>如果某个 fiber 没有子节点的话，那么紧接的执行单元就是兄弟节点。</p>
<p>例子中，fiber <code class="language-text">p</code> 没有子节点，因此 <code class="language-text">a</code> 就是下一个执行单元。</p>
<p>如果 fiber 既没有子节点，也没有兄弟节点，那么就会寻找该 fiber 的”叔叔节点”：也就是父节点的兄弟节点，就比如我们例子中的 <code class="language-text">a</code> 和 <code class="language-text">h2</code> 。</p>
<p>如果父节点不存在兄弟节点，那么我们还会不断向上追溯，寻找这类节点，直到到达根节点为止。到了根节点也意味着，针对这次渲染的所有细分单元工作, 我们均已完成。</p>
<p>现在以代码形式来呈现这一切。</p>
<p>首先从 <code class="language-text">render</code> 中删除渲染的代码, 我们将具体的渲染工作都交付给 <code class="language-text">performUnitOfWork</code></p>
<p>将创建 DOM 节点的方法封装成 <code class="language-text">createDom</code>，后续使用。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dom <span class="token operator">=</span>
    element<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">"TEXT_ELEMENT"</span>
      <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">isProperty</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> key <span class="token operator">!==</span> <span class="token string">"children"</span><span class="token punctuation">;</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">propName</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> dom<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在 <code class="language-text">render</code> 方法中，我们给 <code class="language-text">nextUnitOfWork</code> (下一个工作单元）赋值为 fiber 树的根节点。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nextUnitOfWork <span class="token operator">=</span> <span class="token punctuation">{</span>
    dom<span class="token operator">:</span> container<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>当浏览器准备就绪的时候，会调用 <code class="language-text">workLoop</code> 方法，于是就会从根节点开始我们的渲染进程。</p>
<p>在 <code class="language-text">performUnitOfWork</code> 方法中: </p>
<p>我们首先创建一个新的节点, 然后将其添加到 DOM 中。这个新节点会存储在 <code class="language-text">fiber.dom</code> 中:</p>
<p>然后针对每一个子元素，我们都创建一个新的 fiber 。</p>
<p>之后将其添加到 fiber 树中，根据情况设置为子节点或者是兄弟节点。</p>
<p>最后我们实现对下一个工作单元的搜寻工作。首先是子节点，接着是兄弟节点，然后是叔叔节点，以此类推。</p>
<p>最后就实现了 <code class="language-text">performUnitOfWork</code> 方法。下面是完整的代码：</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 新增 DOM 节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">=</span> <span class="token function">createDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 对每一个 child 都创建一个新的 fiber </span>
  <span class="token keyword">const</span> elements <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> prevSibling <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> elements<span class="token punctuation">[</span>index<span class="token punctuation">]</span>

    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
      props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      parent<span class="token operator">:</span> fiber<span class="token punctuation">,</span>
      dom<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber
    <span class="token punctuation">}</span>

    prevSibling <span class="token operator">=</span> newFiber
    index<span class="token operator">++</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> fiber
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> nextFiber<span class="token punctuation">.</span>sibling
    <span class="token punctuation">}</span>
    nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="渲染与提交阶段-commit" style="position:relative;"><a href="#%E6%B8%B2%E6%9F%93%E4%B8%8E%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5-commit" aria-label="渲染与提交阶段 commit permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>渲染与提交阶段 Commit</h2>
<p>现在我们又遇到了另一个问题。</p>
<p>每开始处理一个元素，我们都会创建一个新的节点到 DOM 中。但是根据目前的代码实现, 在整棵树在 DOM 中渲染完成之前，浏览器是有机会阻碍我们渲染流程的进行的。这样的话，用户就很可能会在此过程中看见一个不完整的 UI ，这不是我们所期待的行为。</p>
<p>因此我们要把引起 DOM 变化部分的代码移除。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token operator">~</span><span class="token operator">~</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token operator">~</span><span class="token operator">~</span></code></pre></div>
<p>同时，要开始监视 fiber 树根节点的变化。我们将监视变化的节点叫做 <code class="language-text">wipRoot</code> 。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
    dom<span class="token operator">:</span> container<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  nextUnitOfWork <span class="token operator">=</span> wipRoot
<span class="token punctuation">}</span>

<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> wipRoot <span class="token operator">=</span> <span class="token keyword">null</span>

	<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 见上</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>一旦所有工作完成之后（当没有下一个工作单元的时候，就表示所有工作都完成了），再将最终的 fiber 树交给 DOM。</p>
<p>这部分的工作，交给 <code class="language-text">commitRoot</code> 函数来完成。在这里我们递归地将所有节点添加到 DOM 中。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  wipRoot <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom
  domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="协调-reconciliation" style="position:relative;"><a href="#%E5%8D%8F%E8%B0%83-reconciliation" aria-label="协调 reconciliation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>协调 Reconciliation</h2>
<p>截止目前，我们依然只是简单地添加节点到 DOM 中，那么更新和删除 DOM 节点需要怎么处理呢？</p>
<p>接下来要开始这部分的处理，我们要对在 <code class="language-text">render</code> 方法中获取到的 fiber 树，与前一次已经插入到 DOM 中的 fiber 树进行对比。</p>
<p>因此，我们需要在 fiber 树在被插入 DOM 中之前，把它缓存下来，作为对比的对象，我们把它叫做：<code class="language-text">currentRoot</code> </p>
<p>对于每一个 fiber，我们还会添加一个属性：<code class="language-text">alternate</code> ，它是与旧版本 fiber 的连接，也就是之前缓存下来的前一个版本的 fiber 树中的内容。</p>
<p>现在将 <code class="language-text">performUnitOfWork</code> 方法中创建新 fiber 的代码提取出来，添加到一个名为 <code class="language-text">reconcileChildren</code> 方法中。</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">=</span> <span class="token function">createDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> elements <span class="token operator">=</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> elements<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fiber<span class="token punctuation">.</span>child
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> fiber
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> nextFiber<span class="token punctuation">.</span>sibling
    <span class="token punctuation">}</span>
    nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后我们开始处理旧的 fiber 和新的元素们。</p>
<p>同时对旧 fiber 的子节点们（<code class="language-text">wipFiber.alternate</code>）和新元素的数组进行循环遍历的操作。</p>
<p>如果我们忽略所有进行循环遍历的样板代码，会发现在循环中最重要的内容是 <code class="language-text">oldFiber</code> 和 <code class="language-text">element</code> 。<code class="language-text">**element</code> 是我们希望渲染到 DOM 中的内容，<code class="language-text">oldFiber</code> 是前一次渲染的 fiber 树。**</p>
<p>我们需要对它们进行对比, 以确定我们是否需要对 DOM 做出任何修改的操作.</p>
<p>具体方式是对比类型:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> sameType <span class="token operator">=</span> oldFiber <span class="token operator">&amp;&amp;</span> element <span class="token operator">&amp;&amp;</span> element<span class="token punctuation">.</span>type <span class="token operator">==</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO update the node</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO add this node</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO delete the oldFiber's node</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>如果旧的 fiber 和新的元素类型是一样的, 我们就保持原先的 DOM 节点, 直接使用新的 props 更新.</li>
<li>如果两个类型不一致, 并且有新的元素出现, 那么我们就要创建一个新的 DOM 节点.</li>
<li>如果两个类型不一致, 但是旧的 filber 依然存在, 那么我们就要移除旧有节点.</li>
</ul>
<p>在这里, React 还使用了 key 以更好地实现协调. 举个例子, 当元素的子元素在元素数组中改变位置时, 也会被检测到.</p>
<p>当旧的 fiber 与新的元素类型一致时, 我们开始创建一个新的 fiber 来隔离 DOM 节点与旧的 fiber, 以及元素中传下来的 props.</p>
<p>与此同时, 我们还会给 fiber 添加一个新的属性: <code class="language-text">effectTag</code> , 在提交阶段使用:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
    dom<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
    parent<span class="token operator">:</span> wipFiber<span class="token punctuation">,</span>
    alternate<span class="token operator">:</span> oldFiber<span class="token punctuation">,</span>
    effectTag<span class="token operator">:</span> <span class="token string">"UPDATE"</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>对于需要一个新 DOM 节点的情况, 我们将 <code class="language-text">effectTag</code> 的值设为 <code class="language-text">PLACEMENT</code></p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newFiber <span class="token operator">=</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> element<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
    props<span class="token operator">:</span> element<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
    dom<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    parent<span class="token operator">:</span> wipFiber<span class="token punctuation">,</span>
    alternate<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    effectTag<span class="token operator">:</span> <span class="token string">"PLACEMENT"</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>然后是需要删除 DOM 节点的情况, 我们不需要创建新 fiber, 只需要将值为 <code class="language-text">DELETION</code> 的 <code class="language-text">effectTag</code> 属性添加到旧的 fiber 上即可.</p>
<p>不过当我们将这个 fiber 树提交给 DOM 时, 需要通过 work in progress 节点 (<code class="language-text">wipRoot</code>), 其中不包含旧的 fibers.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  oldFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token string">"DELETION"</span><span class="token punctuation">;</span>
  deletions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>因此我们需要有一个数组来存储需要被删除的 fibers.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
    dom<span class="token operator">:</span> container<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    alternate<span class="token operator">:</span> currentRoot<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  nextUnitOfWork <span class="token operator">=</span> wipRoot
<span class="token punctuation">}</span>

<span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> currentRoot <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> wipRoot <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> deletions <span class="token operator">=</span> <span class="token keyword">null</span></code></pre></div>
<p>当我们将改动提交给 DOM 时, 我们需要的就是以上数组中的 fibers.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  deletions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>wipRoot<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  currentRoot <span class="token operator">=</span> wipRoot
  wipRoot <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span></code></pre></div>
<p>现在我们开始修改 <code class="language-text">commitWork</code> 函数以处理这些新的 <code class="language-text">effectTag</code>.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom
  domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>如果 fiber 的 effectTag 属性值为 <code class="language-text">PLACEMENT</code>, 我们还是执行同样的操作, 将 DOM 节点添加到父 fiber 对应的节点中,</p>
<p>如果是 <code class="language-text">DELETION</code> 的话, 则删除这个子节点.</p>
<p>如果是 <code class="language-text">UPDATE</code> 的话, 则更新已存在的 DOM 节点, 同时更新 props, 具体的操作在 <code class="language-text">updateDom</code> 方法中实现</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">"PLACEMENT"</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">"UPDATE"</span> <span class="token operator">&amp;&amp;</span> fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">"DELETION"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">updateDom</code> 中, 我们对比新旧 fiber 中的 props, 移除已经不存在的 props, 更新新建的或者是已经改变的 props.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">isProperty</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span> key <span class="token operator">!==</span> <span class="token string">"children"</span>
<span class="token keyword">const</span> <span class="token function-variable function">isNew</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token parameter">key</span> <span class="token operator">=></span>
  prev<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> next<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">isGone</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">prev<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token parameter">key</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> next<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">updateDom</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> prevProps<span class="token punctuation">,</span> nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Remove old properties</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">isGone</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// Set new or changed properties</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isProperty<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      dom<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> nextProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>其中有一类 prop 比较特殊, 就是事件处理器, 我们通过 prop 名中是否含有 <code class="language-text">on</code> 前缀来判断是否是这类 prop.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">isEvent</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"on"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">isProperty</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=></span>
  key <span class="token operator">!==</span> <span class="token string">"children"</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isEvent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></code></pre></div>
<p>如果事件处理函数有任何变化, 我们就从旧的节点中删除它</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token comment">//Remove old or changed event listeners</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isEvent<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> eventType <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> prevProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>同时添加修改后的事件处理函数:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token comment">// Add event listeners</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isEvent<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">isNew</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> eventType <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dom<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> nextProps<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>含有协调功能的 react 实现完整代码: <a href="https://github.com/icyfish/didact/blob/master/src/index_v2.jsx" target="_blank" rel="nofollow noopener noreferrer">React With Reconcilation</a></p>
<h2 id="函数式组件" style="position:relative;"><a href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6" aria-label="函数式组件 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>函数式组件</h2>
<p>接下来我们要做的是支持函数组件.</p>
<p>首先修改示例. 我们使用一个简单的函数式组件, 它返回一个 <code class="language-text">h1</code> 元素.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token comment">/** @jsx Didact.createElement */</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token plain-text">Hi </span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">App</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>foo<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span>
Didact<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span></code></pre></div>
<p>将 jsx 转换成 js 的话, 就是这样:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Didact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
    <span class="token string">"h1"</span><span class="token punctuation">,</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token string">"Hi "</span><span class="token punctuation">,</span>
    props<span class="token punctuation">.</span>name
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> Didact<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>App<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>函数式组件在以下两个方面与普通组件有所区别:</p>
<ul>
<li>函数式组件的 fiber 不存在 DOM 节点.</li>
<li>它的子元素的产生来自于函数式组件的执行, 而不是通过 <code class="language-text">props</code> 传入</li>
</ul>
<p>在 <code class="language-text">performUnitOfWork</code> 函数中, 我们检查 fiber 的类型是否是函数, 根据结果执行不同的更新操作.</p>
<p>拆分出函数式组件的处理方法 <code class="language-text">updateHostComponent</code> 和普通组件 的处理方法<code class="language-text">updateHostComponent</code>.</p>
<p><code class="language-text">updateHostComponent</code> 所做的工作与原来一致:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">=</span> <span class="token function">createDom</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在 <code class="language-text">updateFunctionComponent</code> 中, 我们执行这个函数组件以获取子元素. </p>
<p>在我们的例子中, <code class="language-text">fiber.type</code> 的值为 <code class="language-text">App</code> 函数, 执行它时, 会返回 <code class="language-text">h1</code> 元素.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>fiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>获取到子元素之后, 协调的工作还是和前一个版本没有区别, 因此不需要做出修改.</p>
<p>接下来需要修改的是 <code class="language-text">commitWork</code> 函数.</p>
<p>开始处理没有 DOM 节点属性的 fibers, 需要修改两处:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">"PLACEMENT"</span> <span class="token operator">&amp;&amp;</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">"UPDATE"</span> <span class="token operator">&amp;&amp;</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateDom</span><span class="token punctuation">(</span>
      fiber<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
      fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      fiber<span class="token punctuation">.</span>props
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">"DELETION"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>首先要找到 DOM 节点的父节点, 在 fiber 树中不断向上寻找直到找到一个存在 DOM 节点的 fiber.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> domParentFiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>domParentFiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParentFiber <span class="token operator">=</span> domParentFiber<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> domParent <span class="token operator">=</span> domParentFiber<span class="token punctuation">.</span>dom

  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">"PLACEMENT"</span> <span class="token operator">&amp;&amp;</span>
    fiber<span class="token punctuation">.</span>dom <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>删除节点也是, 需要不断寻找知道找到存在 DOM 节点的 fiber.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> domParent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>dom
   <span class="token keyword">if</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// xxx</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token string">"DELETION"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
  <span class="token function">commitWork</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> domParent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    domParent<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>dom<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">commitDeletion</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>child<span class="token punctuation">,</span> domParent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="hooks" style="position:relative;"><a href="#hooks" aria-label="hooks permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hooks</h2>
<p>最后一步是实现为函数式组件添加状态. </p>
<p>现在我们将 app 示例进行修改, 改为一个比较经典的计数器应用. 每一次点击计数器的数值就会加上1. </p>
<p>我们使用 <code class="language-text">Didact.useState</code> 来读取和更新计数器的值.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token comment">/** @jsx Didact.createElement */</span>
<span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> Didact<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      Count: </span><span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Counter</span></span> <span class="token punctuation">/></span></span></code></pre></div>
<p>接下来开始实现 <code class="language-text">useState</code> 方法.</p>
<p>在调用函数式组件之前, 我们需要初始化一些全局变量, 然后在 <code class="language-text">useState</code> 方法中使用它们.</p>
<p>首先我们设置正在工作的 fiber (<code class="language-text">wipFiber</code>). </p>
<p>为这个 filber 设置 <code class="language-text">hooks</code> 属性以支持 <code class="language-text">useState</code> 在同一个组件中多次被调用, 由于被调用多次, 我们还需要关注当前的 hook 索引.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">let</span> wipFiber <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">let</span> hookIndex <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  wipFiber <span class="token operator">=</span> fiber
  hookIndex <span class="token operator">=</span> <span class="token number">0</span>
  wipFiber<span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>fiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>当函数式组件调用 <code class="language-text">useState</code> 时, 我们会检查是否有一个旧的 hook 存在. 通过 fiber 的 <code class="language-text">alternate</code> 和 hook 索引得到我们想要的结果.</p>
<p>如果存在一个旧的 hook, 那么我们就会将旧 hook 所存储的 state 拷贝到新的 hook 中. 如果不存在的话, 则初始化一个 state.</p>
<p>然后添加新的 hook 到 fiber 中, index 加上1, 然后返回这个 state.</p>
<p><code class="language-text">useState</code> 同时还需要返回一个函数, 用以更新 state. 于是我们定义一个 <code class="language-text">setState</code> 方法. 接受一个 action 作为参数, 在计数器的例子中, 这个 action 是每次点击为数字的值增加1.</p>
<p>我们给 <code class="language-text">hook</code> 添加一个 队列 <code class="language-text">queue</code> 属性, 每次用户调用 <code class="language-text">setState</code>, 就把这个 action 添加到队列中.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> <span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token parameter">action</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
    dom<span class="token operator">:</span> currentRoot<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
    props<span class="token operator">:</span> currentRoot<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
    alternate<span class="token operator">:</span> currentRoot
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  nextUnitOfWork <span class="token operator">=</span> wipRoot<span class="token punctuation">;</span>
  deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>将这个 action 添加到 <code class="language-text">hook</code> 的属性 <code class="language-text">queue</code> 中.</p>
<p>接下来做一些与在 <code class="language-text">render</code> 函数中类似的事情. 设置一个新的追踪节点(<code class="language-text">wipRoot</code>), 在下一次工作进程开始时, 循环中可以开始一次新的渲染流程.</p>
<p>接下来是执行 action, 在下一次组件重新渲染时, 我们会从旧的 hook 队列中读取到所有 action. 之后我们会在新的 hook 状态中一一执行这些 action, 然后返回最新的状态.</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initial</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldHook <span class="token operator">=</span>
    wipFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span>
    wipFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token punctuation">]</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    state<span class="token operator">:</span> oldHook <span class="token operator">?</span> oldHook<span class="token punctuation">.</span>state <span class="token operator">:</span> initial<span class="token punctuation">,</span>
    queue<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

	<span class="token keyword">const</span> actions <span class="token operator">=</span> oldHook <span class="token operator">?</span> oldHook<span class="token punctuation">.</span>queue <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  actions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">action</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    hook<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">action</span><span class="token punctuation">(</span>hook<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token parameter">action</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    hook<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    wipRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
      dom<span class="token operator">:</span> currentRoot<span class="token punctuation">.</span>dom<span class="token punctuation">,</span>
      props<span class="token operator">:</span> currentRoot<span class="token punctuation">.</span>props<span class="token punctuation">,</span>
      alternate<span class="token operator">:</span> currentRoot<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    nextUnitOfWork <span class="token operator">=</span> wipRoot
    deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  wipFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span>
  hookIndex<span class="token operator">++</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>最终版本的代码: <a href="https://codesandbox.io/s/didact-8-21ost" target="_blank" rel="nofollow noopener noreferrer">React With Hooks</a></p>
<h2 id="后记" style="position:relative;"><a href="#%E5%90%8E%E8%AE%B0" aria-label="后记 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后记</h2>
<p>这篇文章除了帮助大家理解 React 的实现原理之外, 还有一个目的就是希望大家在阅读完之后能更容易地探索 React 源码. 这也是我们在文章中使用与源码一致的变量名和函数名的原因.</p>
<p>举个例子, 如果你在实际的 React 应用中, 在函数式组件里添加断点, 调用栈就会是如下这样:</p>
<ul>
<li><code class="language-text">workLoop</code></li>
<li><code class="language-text">performUnitOfWork</code></li>
<li><code class="language-text">updateFunctionComponent</code></li>
</ul>
<p>当然, 教程中并没有覆盖到全部的 React 特性以及优化点. 举个例子, 下面是 React 与我们的源码实现地不同的地方:</p>
<ul>
<li>在 Didact 中, 我们在 <code class="language-text">render</code> 阶段遍历了整个树. 而 React 并不会这样做, 当子树没有任何变化的话, 某些不必要的渲染流程就会被跳过.</li>
<li>同时在提交阶段, 我们也遍历了整个树, 而 React 则是维护了一个链表, 只关注有 <code class="language-text">effectTag</code> 的 fiber, 只遍历这些 fiber.</li>
<li>每次我们创建一个新的工作节点时, 都会在每个 fiber 中创建新的对象. 而 React 则会从先前的树中回收这些 fiber.</li>
<li>当 Didact 在 <code class="language-text">render</code> 阶段执行一次更新时, 会将追踪工作树完全移除, 然后从根节点再重新开始流程. 而 React 的每一个 tag 则是维护了一个时间戳, 根据是否超时来确定此次更新的优先级.</li>
<li>以及更多…</li>
</ul>
<p>你还可以很方便地添加 React 相关的其他特性:</p>
<ul>
<li>处理值为对象的 <code class="language-text">style</code> 属性</li>
<li><a href="https://github.com/pomber/didact/issues/11" target="_blank" rel="nofollow noopener noreferrer">实现子元素的扁平化</a></li>
<li><code class="language-text">useEffect</code></li>
<li>根据 key 进行协调</li>
</ul></div><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/blog/tag/react/">React</a></li></ul></div></div></div><div class="Post-module--post__footer--3WzWU"></div><div class="Post-module--post__comments--25y6I"></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/build-your-own-react/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-8de6de3a6555a9e76093.js"],"app":["/app-7bab443a509de4091087.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-fd4fb51a6fac1c18bdde.js"],"component---src-templates-categories-list-template-js":["/component---src-templates-categories-list-template-js-91533c34d4c04158b3bf.js"],"component---src-templates-category-template-js":["/component---src-templates-category-template-js-9a8ab6a02add1d489a0d.js"],"component---src-templates-index-template-js":["/component---src-templates-index-template-js-e133b6bf534af92835e5.js"],"component---src-templates-not-found-template-js":["/component---src-templates-not-found-template-js-ea42bffee1320a898f17.js"],"component---src-templates-page-template-js":["/component---src-templates-page-template-js-9a81f4ebf13f285e62da.js"],"component---src-templates-post-template-js":["/component---src-templates-post-template-js-80973b30dfbf72fe7e5d.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-02327161be6f6fce449d.js"],"component---src-templates-tags-list-template-js":["/component---src-templates-tags-list-template-js-5eb45ea93f9e416dc132.js"]};/*]]>*/</script><script src="/blog/polyfill-8de6de3a6555a9e76093.js" nomodule=""></script><script src="/blog/component---src-templates-post-template-js-80973b30dfbf72fe7e5d.js" async=""></script><script src="/blog/cd95ea5cbd2c605f26db819f07999610c9ff4310-cb79b714c9287bd00e29.js" async=""></script><script src="/blog/styles-407fe62976dc5310c43e.js" async=""></script><script src="/blog/app-7bab443a509de4091087.js" async=""></script><script src="/blog/dc6a8720040df98778fe970bf6c000a41750d3ae-5954f1f1c3eead9a6f74.js" async=""></script><script src="/blog/532a2f07-549094fa347c85980056.js" async=""></script><script src="/blog/framework-1e331b2e9d55ebef6dec.js" async=""></script><script src="/blog/webpack-runtime-c615a6c0065154c9a66f.js" async=""></script></body></html>