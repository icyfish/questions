---
title: ç†è§£ useEffect
date: "2021-06-08"
template: "post"
draft: false
toc: true
description: "A Complete Guide to useEffect"
---

åŸæ–‡: [A Complete Guide to useEffect](https://overreacted.io/a-complete-guide-to-useeffect/)

TLDR Part

### æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„ Props å’Œ State

å¼€å§‹èŠ effect ä¹‹å‰, æˆ‘ä»¬éœ€è¦å…ˆèŠä¸€èŠç»„ä»¶çš„æ¸²æŸ“.

ä»¥ä¸‹æ˜¯ä¸€ä¸ªè®¡æ—¶å™¨ç»„ä»¶. å…³æ³¨å…¶ä¸­é«˜äº®çš„éƒ¨åˆ†:

```jsx
function Counter() {
  const [count, setCount] = useState(0)

  return (
    <div>
      // highlight-next-line
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  )
}
```

è¿™ä»£è¡¨è¿™ä»€ä¹ˆå‘¢? `count` æ˜¯å¦åœ¨æ—¶åˆ»å…³æ³¨æˆ‘ä»¬çš„çŠ¶æ€(state)å˜åŒ–, ç„¶åè‡ªåŠ¨æ›´æ–°å‘¢? ä½œä¸ºä¸€ä¸ªååˆ†ç¬¦åˆç›´è§‰çš„ç­”æ¡ˆ, è¿™æ ·çš„æƒ³æ³•å¯èƒ½ä¼šåœ¨ä½ åˆšå¼€å§‹å­¦ä¹  React çš„æ—¶å€™ç»™ä½ å¸¦æ¥æ¯”è¾ƒå¤§çš„å¸®åŠ©. ä½†æ˜¯å®é™…ä¸Š, è¿™ä¸ªç†è§£å¹¶ä¸å‡†ç¡®. æˆ‘å†™è¿‡ä¸€ç¯‡å…³äºè¿™ä¸ªè¯é¢˜çš„æ–‡ç« , è¿™æ‰æ˜¯[å‡†ç¡®çš„å¿ƒæ™ºæ¨¡å‹](https://overreacted.io/react-as-a-ui-runtime/). <mark>åŠ ä¸Šè¯‘æ–‡</mark>

**åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, `count` ä»…ä»…æ˜¯ä¸ªæ•°å­—è€Œå·².** å†…éƒ¨å¹¶æ²¡æœ‰æ•°æ®ç»‘å®š, "è§‚å¯Ÿè€…", "ä»£ç†"ç­‰ç­‰çš„é€»è¾‘. å°±åƒä¸‹é¢çš„ä»£ç ç¤ºä¾‹ä¸€æ ·, å®ƒå°±æ˜¯ä¸€ä¸ªæ•°å­—.

```jsx
const count = 42
// ...
;<p>You clicked {count} times</p>
// ...
```

å½“ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™, ä» `useState()` ä¸­è¯»å–åˆ°çš„ `count` æ˜¯ `0`. å½“æˆ‘ä»¬è°ƒç”¨äº† `setCount(1)` ä¹‹å, React ä¼šé‡æ–°è°ƒç”¨æˆ‘ä»¬çš„ç»„ä»¶. è¿™ä¸€æ¬¡ `count` å€¼å°†ä¼šæ˜¯ `1`, ä»¥æ­¤ç±»æ¨:

```jsx
// é¦–æ¬¡æ¸²æŸ“
function Counter() {
  // highlight-next-line
  const count = 0 // useState() è¿”å›çš„å†…å®¹
  // ...
  ;<p>You clicked {count} times</p>
  // ...
}

// ç‚¹å‡»äº‹ä»¶ä¹‹å, å‡½æ•°å†æ¬¡è¢«è°ƒç”¨
function Counter() {
  // highlight-next-line
  const count = 1 // useState() è¿”å›çš„å†…å®¹
  // ...
  ;<p>You clicked {count} times</p>
  // ...
}

// ç¬¬äºŒæ¬¡ç‚¹å‡»äº‹ä»¶ä¹‹å, å‡½æ•°è¢«è°ƒç”¨
function Counter() {
  // highlight-next-line
  const count = 2 // useState() è¿”å›çš„å†…å®¹
  // ...
  ;<p>You clicked {count} times</p>
  // ...
}
```

**æ— è®ºä½•æ—¶, çŠ¶æ€æ›´æ–°ä¹‹å, React éƒ½ä¼šé‡æ–°è°ƒç”¨æˆ‘ä»¬çš„ç»„ä»¶. æ¯ä¸€æ¬¡æ¸²æŸ“çš„ç»“æœéƒ½ä¼š"çœ‹åˆ°"ç»„ä»¶å†…éƒ¨çš„ `counter` çŠ¶æ€å€¼, è€Œè¿™ä¸ªå€¼åœ¨å‡½æ•°ä¸­å®é™…ä¸Šæ˜¯ä¸€ä¸ªå›ºå®šå€¼.**

æ‰€ä»¥è¯´ä»¥ä¸‹è¿™ä¸€è¡Œçš„ä»£ç å¹¶æ²¡æœ‰ä»»ä½•ç‰¹æ®Šçš„æ•°æ®ç»‘å®šé€»è¾‘:

```jsx
<p>You clicked {count} times</p>
```

**å®ƒä»…ä»…åªæ˜¯å°†æ•°å­—çš„å€¼åµŒå…¥åˆ°æ¸²æŸ“ç»“æœä¸­è€Œå·².** è¿™ä¸ªæ•°å­—æ˜¯ç”± React æä¾›çš„. å½“æˆ‘ä»¬è°ƒç”¨ `setCount` çš„æ—¶å€™, React ä¼šç”¨ä¸€ä¸ªæœ€æ–°çš„ `count` å€¼æ¥é‡æ–°è°ƒç”¨æˆ‘ä»¬çš„ç»„ä»¶. ç„¶å React æ›´æ–° DOM, ä»¥åŒ¹é…æœ€æ–°çš„æ¸²æŸ“ç»“æœ.

è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯: `count` å€¼åœ¨æ¯æ¬¡æ¸²æŸ“çš„è°ƒç”¨ä¸­, éƒ½æ˜¯å›ºå®šçš„. æ˜¯æˆ‘ä»¬çš„ç»„ä»¶ä¼ é€’äº†æœ€æ–°çš„ `count` å€¼, æ¯ä¸€æ¬¡æ¸²æŸ“, æ¸²æŸ“ç»“æœéƒ½è¾“å‡ºäº†è¿™ä¸ªå€¼. æ¯ä¸€æ¬¡æ¸²æŸ“çš„ `count` éƒ½äº’ä¸å…³è”.

(æƒ³è¦æ›´æ·±å…¥åœ°äº†è§£å…·ä½“çš„æ¸²æŸ“æµç¨‹, å¯ä»¥æŸ¥çœ‹è¿™ç¯‡æ–‡ç« : [React ä½œä¸º UI è¿è¡Œæ—¶](https://overreacted.io/react-as-a-ui-runtime/))

### æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„äº‹ä»¶å¤„ç†å™¨

æŸ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹. æˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ª 3 ç§’çš„å®šæ—¶å™¨, ä¹‹åå¼¹å‡º `count` å€¼:

```jsx
function Counter() {
  const [count, setCount] = useState(0)
  // highlight-start
  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count)
    }, 3000)
  }
  // highlight-end

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
      // highlight-start
      <button onClick={handleAlertClick}>Show alert</button>
      // highlight-end
    </div>
  )
}
```

æˆ‘æŒ‰é¡ºåºåšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…:

- å°†è®¡æ—¶å™¨çš„å€¼**å¢åŠ **åˆ° 3
- **ç‚¹å‡»**"Show alert"
- åœ¨å®šæ—¶å™¨çš„å›è°ƒè¢«æ‰§è¡Œä¹‹å‰å°†è®¡æ—¶å™¨çš„å€¼**å¢åŠ **åˆ° 5

![counter](./counter.gif)

ä½ è®¤ä¸º `alert` çš„ç»“æœæ˜¯ä»€ä¹ˆå‘¢? æ˜¯ `alert` æ—¶çš„ state å€¼ 5, è¿˜æ˜¯ç‚¹å‡»æ—¶çš„ state å€¼ 3?

---

å‰§é€:

---

å¯ä»¥åœ¨[è¿™é‡Œ](https://codesandbox.io/s/w2wxl3yo0l)è‡ªå·±è¯•ä¸€è¯•!

å¦‚æœè¿™ä¸ªç¤ºä¾‹å¯¹ä½ æ¥è¯´å¾ˆè´¹è§£, å¯ä»¥æƒ³è±¡ä¸€ä¸ªæ›´å®é™…çš„ä¾‹å­: ä¸€ä¸ªèŠå¤©åº”ç”¨, å°† count ç±»æ¯”ä¸ºå½“å‰æ¥å—çš„æ¶ˆæ¯å¯¹åº”çš„ ID, å­˜å‚¨åœ¨å±€éƒ¨çŠ¶æ€ä¸­, å°†æŒ‰é’®ç±»æ¯”ä¸ºå‘é€æ¶ˆæ¯çš„æŒ‰é’®. [è¿™ç¯‡æ–‡ç« ](https://overreacted.io/how-are-function-components-different-from-classes/)è¯¦ç»†è§£é‡Šäº†å‡ºç°ä¸Šè¿°ç»“æœçš„åŸå› , æ­£ç¡®ç­”æ¡ˆæ˜¯ 3.

`alert` ä¼š"æ•æ‰"ç‚¹å‡»å½“æ—¶ state çš„å€¼.

<mark>(There are ways to implement the other behavior too but Iâ€™ll be focusing on the default case for now. When building a mental model, itâ€™s important that we distinguish the â€œpath of least resistanceâ€ from the opt-in escape hatches.)</mark>

---

ä½†æ˜¯å…¶ä¸­çš„åŸç†æ˜¯æ€æ ·çš„å‘¢?

æˆ‘ä»¬å…ˆå‰æåˆ°è¿‡, `count` å€¼åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½æ˜¯ä¸€ä¸ªå›ºå®šå€¼. æœ‰å¿…è¦é‡ç‚¹æŒ‡å‡ºçš„æ˜¯ -- **æˆ‘ä»¬çš„å‡½æ•°ä¼šè¢«è°ƒç”¨å¤šæ¬¡(æ¯æ¬¡æ¸²æŸ“è¢«è°ƒç”¨ä¸€æ¬¡), æ¯ä¸€æ¬¡è¢«è°ƒç”¨æ—¶, è¿™ä¸ª count å€¼éƒ½ä¼šæ˜¯ç”± useState æ§åˆ¶çš„ä¸€ä¸ªç‰¹å®šå€¼.**

è¿™ç§ç‰¹æ€§å¹¶é React ç‹¬æœ‰ -- æ™®é€šçš„å‡½æ•°ä¹Ÿæ˜¯è¿™æ ·å·¥ä½œçš„:

```js
function sayHi(person) {
  // highlight-next-line
  const name = person.name
  setTimeout(() => {
    alert("Hello, " + name)
  }, 3000)
}

let someone = { name: "Dan" }
sayHi(someone)

someone = { name: "Yuzhi" }
sayHi(someone)

someone = { name: "Dominic" }
sayHi(someone)
```

åœ¨è¿™ä¸ª[ç¤ºä¾‹](https://codesandbox.io/s/mm6ww11lk8)ä¸­, å¤–éƒ¨çš„ `someone` å˜é‡è¢«å¤šæ¬¡é‡æ–°èµ‹å€¼. (å°±åƒåœ¨ React ä¸­, å½“å‰ç»„ä»¶çš„ state ä¸æ–­å˜åŒ–ä¸€æ ·. ) **åœ¨ `sayHi` å†…éƒ¨, æœ‰ä¸€ä¸ªå˜é‡ `name`, å®ƒä¼šè¯»å– `person` çš„ `name` å±æ€§.** è¿™ä¸ªå˜é‡åœ¨å‡½æ•°å†…éƒ¨, æ¯æ¬¡è°ƒç”¨ä¹‹é—´éƒ½æ˜¯ç‹¬ç«‹çš„. å› æ­¤, å½“å®šæ—¶å™¨çš„å›è°ƒè¢«è°ƒç”¨çš„æ—¶å€™, æ¯æ¬¡ alert éƒ½ä¼š"è®°ä½"è‡ªå·±çš„ `name`.

è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„äº‹ä»¶å¤„ç†å™¨åœ¨ç‚¹å‡»çš„å½“ä¸‹"æ•æ‰"äº† `count` å€¼. åŒæ ·çš„è§„åˆ™ä¸‹, æ¯æ¬¡æ¸²æŸ“éƒ½èƒ½"çœ‹åˆ°"è‡ªå·±çš„ `count`:

```jsx
// é¦–æ¬¡æ¸²æŸ“
function Counter() {
  // highlight-next-line
  const count = 0 // useState() è¿”å›çš„å†…å®¹
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count)
    }, 3000)
  }
  // ...
}

// ç‚¹å‡»äº‹ä»¶ä¹‹åå‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // highlight-next-line
  const count = 1 // useState() è¿”å›çš„å†…å®¹
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count)
    }, 3000)
  }
  // ...
}

// åˆä¸€æ¬¡ç‚¹å‡»äº‹ä»¶, å‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // highlight-next-line
  const count = 2 // useState() è¿”å›çš„å†…å®¹
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count)
    }, 3000)
  }
  // ...
}
```

æ¯ä¸€æ¬¡æ¸²æŸ“, éƒ½ä¼šè¿”å›å„è‡ªç‰ˆæœ¬çš„ `handleAlertClick`, å¹¶ä¸”æœ‰å„è‡ªç‰ˆæœ¬çš„ `count`:

```jsx
// é¦–æ¬¡æ¸²æŸ“
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      // highlight-next-line
      alert("You clicked on: " + 0)
    }, 3000)
  }
  // ...
  // highlight-next-line
  ;<button onClick={handleAlertClick} /> // å†…éƒ¨å€¼ä¸º 0 çš„ç‰ˆæœ¬
  // ...
}

// ç‚¹å‡»äº‹ä»¶ä¹‹åå‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      // highlight-next-line
      alert("You clicked on: " + 1)
    }, 3000)
  }
  // ...
  // highlight-next-line
  ;<button onClick={handleAlertClick} /> // å†…éƒ¨å€¼ä¸º 1 çš„ç‰ˆæœ¬
  // ...
}

// åˆä¸€æ¬¡ç‚¹å‡»äº‹ä»¶, å‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      // highlight-next-line
      alert("You clicked on: " + 2)
    }, 3000)
  }
  // ...
  // highlight-next-line
  ;<button onClick={handleAlertClick} /> // å†…éƒ¨å€¼ä¸º 2 çš„ç‰ˆæœ¬
  // ...
}
```

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ, åœ¨è¿™é‡Œçš„[ç¤ºä¾‹](https://codesandbox.io/s/w2wxl3yo0l)ä¸­, äº‹ä»¶å¤„ç†å™¨"å±äº"å„è‡ªçš„æ¸²æŸ“, å½“ç”¨æˆ·ç‚¹å‡»çš„æ—¶å€™, ä¼šä½¿ç”¨é‚£æ¬¡æ¸²æŸ“çš„ `counter` å€¼.

**å¯¹äºæ¯ä¸€æ¬¡æ¸²æŸ“, å†…éƒ¨çš„ props å’Œ state å§‹ç»ˆéƒ½æ˜¯ä¸€è‡´çš„, å¹¶ä¸”æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯ç‹¬ç«‹çš„.** æ—¢ç„¶æ¯æ¬¡æ¸²æŸ“çš„ props å’Œ state å„è‡ªç‹¬ç«‹, æ¶ˆè´¹å®ƒä»¬çš„éƒ¨åˆ†(åŒ…æ‹¬äº‹ä»¶å¤„ç†å™¨), åœ¨æ¸²æŸ“é—´ä¹Ÿå„è‡ªç‹¬ç«‹, éƒ½ä»å±äºç‰¹å®šçš„æ¸²æŸ“. å› æ­¤äº‹ä»¶å¤„ç†å™¨å†…éƒ¨çš„å¼‚æ­¥å‡½æ•°ä¹Ÿä¼š"çœ‹åˆ°"åŒæ ·çš„ `count` å€¼.

_è¾¹æ³¨: æˆ‘åœ¨ `handleAlertClick` ä¸­ç›´æ¥ä½¿ç”¨äº† `count` å€¼. è¿™æ ·çš„æ›¿æ¢æ˜¯å®‰å…¨çš„, å› ä¸ºåœ¨ä¸€æ¬¡æ¸²æŸ“æµç¨‹ä¸­, `count` å€¼ä¸å¯èƒ½æœ‰å˜åŒ–. å®ƒè¢«å£°æ˜ä¸º `const`, ä¸”æ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ•°å­—. åŒæ ·çš„åŸåˆ™åœ¨å¯¹è±¡ä¸­ä»ç„¶é€‚ç”¨, ä¸è¿‡æˆ‘ä»¬å¿…é¡»è¦ç¡®ä¿é¿å…æ”¹å˜(mutate)çŠ¶æ€çš„å€¼. ç”¨ä¸€ä¸ªå…¨æ–°åˆ›å»ºçš„å¯¹è±¡å»è°ƒç”¨ `setSomething(newObj)`, è€Œä¸æ”¹å˜è¿™ä¸ªå¯¹è±¡å°±å¯ä»¥äº†. è¿™æ ·çš„è¯, å‰ä¸€æ¬¡æ¸²æŸ“çš„çŠ¶æ€(state)å€¼å°±èƒ½å¤Ÿä¿æŒä¸è¢«ä¸‹ä¸€æ¬¡æ¸²æŸ“ä¿®æ”¹._

### æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„å‰¯ä½œç”¨

è¿™ç¯‡æ–‡ç« çš„ä¸»è¦å†…å®¹æœ¬è¯¥æ˜¯å‰¯ä½œç”¨(effect)çš„, ç°åœ¨æˆ‘ä»¬ä¼šå¼€å§‹è¯¦ç»†ä»‹ç»å®ƒ. å…¶å®, å‰¯ä½œç”¨çš„å’Œä»¥ä¸Šä¸¤éƒ¨åˆ†æ˜¯ä¸€æ ·çš„, æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰è‡ªå·±çš„å‰¯ä½œç”¨.

ç°åœ¨æˆ‘ä»¬å›åˆ° React [æ–‡æ¡£](https://reactjs.org/docs/hooks-effect.html)ä¸­çš„ä¸€ä¸ªä¾‹å­:

```jsx
function Counter() {
  const [count, setCount] = useState(0)
  // highlight-start
  useEffect(() => {
    document.title = `You clicked ${count} times`
  })
  // highlight-end

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  )
}
```

**æˆ‘æƒ³æå‡ºä¸€ä¸ªé—®é¢˜: effect æ˜¯å¦‚ä½•è¯»å–åˆ° `count` çš„æœ€æ–°å€¼çš„?**

åœ¨ effect å‡½æ•°çš„å†…éƒ¨æœ‰ä¸€äº›æ•°æ®ç»‘å®šæˆ–è€…è®¢é˜…çš„é€»è¾‘, ä½¿å¾— effect å‡½æ•°æ¯æ¬¡éƒ½èƒ½è¯»å–åˆ° `count` çš„æœ€æ–°å€¼? è¿˜æ˜¯ `count` æ˜¯ä¸€ä¸ªå¯å˜çš„å€¼, React åœ¨ç»„ä»¶çš„å†…éƒ¨ç»´æŠ¤äº†è¿™ä¸ªå€¼, å› æ­¤æˆ‘ä»¬çš„ effect å‡½æ•°èƒ½å¤Ÿè¯»å–åˆ°æœ€æ–°å€¼?

éƒ½ä¸æ˜¯çš„.

å…ˆå‰æˆ‘ä»¬å·²ç»çŸ¥é“, `count` åœ¨æ¯æ¬¡ç‰¹å®šçš„ç»„ä»¶æ¸²æŸ“æµç¨‹ä¸­, éƒ½æ˜¯ä¸€ä¸ªå¸¸é‡. äº‹ä»¶å¤„ç†å™¨ä»å®ƒæ‰€å±çš„æ¸²æŸ“æµç¨‹ä¸­è¯»å–åˆ°äº†å¯¹åº”çš„ `count` å€¼, å› ä¸º `count` æ˜¯å¤„äºå¯¹åº”ä½œç”¨åŸŸçš„å˜é‡. åœ¨ effect å‡½æ•°ä¸­ä¹Ÿæ˜¯è¿™æ ·çš„!

**å¹¶ä¸æ˜¯åœ¨ä¸€ä¸ª"ä¸ä¼šå˜åŒ–"çš„å‰¯ä½œç”¨æ–¹æ³•ä¸­, `count` å˜é‡å€¼æ—¶åˆ»å˜åŒ–. è€Œæ˜¯æ¯ä¸€æ¬¡æ¸²æŸ“, å‰¯ä½œç”¨å‡½æ•°æœ¬èº«éƒ½æ˜¯ä¸ä¸€æ ·çš„.**

åŒæ ·åœ°, æ¯ä¸ªç‰ˆæœ¬çš„å‰¯ä½œç”¨æ–¹æ³•è¯»å–åˆ°çš„éƒ½æ˜¯å½“æ¬¡æ¸²æŸ“æ‰€ä¼ å…¥çš„ `count` å€¼:

```jsx
// é¦–æ¬¡æ¸²æŸ“
function Counter() {
  // ...
  useEffect(
    // highlight-start
    // é¦–æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      document.title = `You clicked ${0} times`
    }
    // highlight-end
  )
  // ...
}

// ç‚¹å‡»äº‹ä»¶ä¹‹åå‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // ...
  useEffect(
    // highlight-start
    // ç¬¬äºŒæ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      document.title = `You clicked ${1} times`
    }
    // highlight-end
  )
  // ...
}

// åˆä¸€æ¬¡ç‚¹å‡»äº‹ä»¶, å‡½æ•°è¢«é‡æ–°è°ƒç”¨
function Counter() {
  // ...
  // highlight-start
  useEffect(
    // ç¬¬ä¸‰æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      document.title = `You clicked ${2} times`
    }
    // highlight-end
  )
  // ..
}
```

React ä¼šè®°ä½æ¯ä¸€æ¬¡ä½ æ‰€æä¾›çš„å‰¯ä½œç”¨æ–¹æ³•, åœ¨å½“æ¬¡æ¸²æŸ“ç»“æŸ, UI å‘ˆç°å‡ºå¯¹åº”å˜åŒ–ä¹‹åè°ƒç”¨è¿™ä¸ªå‰¯ä½œç”¨æ–¹æ³•.

å°½ç®¡è¿™ä¸ªå‰¯ä½œç”¨æ–¹æ³•çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„(åŠŸèƒ½: æ›´æ–°æ–‡æ¡£çš„æ ‡é¢˜), ä½†æ˜¯å®é™…ä¸Šæ¯ä¸€æ¬¡æ¸²æŸ“è¿™ä¸ªæ–¹æ³•éƒ½æ˜¯ä¸ä¸€æ ·çš„ -- å¹¶ä¸”æ¯ä¸€ä¸ªå‰¯ä½œç”¨æ–¹æ³•éƒ½ä¼šçœ‹åˆ°"æ¸²æŸ“"å½“æ¬¡çš„ props å’Œ state.

**åœ¨æ¦‚å¿µä¸Š, ä½ å¯ä»¥æŠŠå‰¯ä½œç”¨æ–¹æ³•ç†è§£ä¸ºæ¯æ¬¡æ¸²æŸ“çš„ç»“æœ.**

ä¸¥æ ¼æ¥è¯´, å…¶å®å®ƒä»¬å¹¶ä¸æ˜¯æ¸²æŸ“ç»“æœ(ä¸ºäº†èƒ½å¤Ÿé€šè¿‡ç®€å•çš„è¯­æ³•[å®ç° Hooks çš„ç»„åˆ](https://overreacted.io/why-do-hooks-rely-on-call-order/), å‡å°‘è¿è¡Œæ—¶å¼€é”€). ä½†æ˜¯åŸºäºæˆ‘ä»¬ç›®å‰æƒ³è¦å»ºç«‹çš„å¿ƒæ™ºæ¨¡å‹, æˆ‘ä»¬å¯ä»¥åœ¨æ¦‚å¿µä¸Šè®¤ä¸ºå‰¯ä½œç”¨å‡½æ•°æ˜¯æŸä¸€æ¬¡æ¸²æŸ“çš„ç»“æœ.

---

ç°åœ¨æ¥å·©å›ºä¸€ä¸‹ä»¥ä¸Šçš„å†…å®¹, é¦–å…ˆå›é¡¾é¦–æ¬¡æ¸²æŸ“:

- **React:** å½“ state å€¼ä¸º `0` çš„æ—¶å€™, ç»™æˆ‘ä½ å¸Œæœ›æ¸²æŸ“çš„ UI.
- **ç»„ä»¶:**
  - è¿™æ˜¯æˆ‘è¦æ¸²æŸ“çš„å†…å®¹: `<p>You clicked 0 times</p>`.
  - æ¸²æŸ“ç»“æŸä¹‹åè¯·æ‰§è¡Œè¿™ä¸ªå‰¯ä½œç”¨æ–¹æ³•: `() => { document.title = 'You clicked 0 times' }`.
- **React:** å¥½çš„, æ›´æ–° UI. Hey, æµè§ˆå™¨, æˆ‘æƒ³è¦åœ¨ DOM ä¸­æ·»åŠ ä¸€äº›å†…å®¹.
- **æµè§ˆå™¨:** å¥½çš„, æˆ‘æŠŠå®ƒä»¬ç»˜åˆ¶åˆ°å±å¹•ä¸­.
- **React:** å¥½çš„, æˆ‘å‡†å¤‡å¼€å§‹æ‰§è¡Œå‰¯ä½œç”¨æ–¹æ³•äº†.
  - æ‰§è¡Œ `() => { document.title = 'You clicked 0 times' }`.

---

ç°åœ¨å›é¡¾ç‚¹å‡»ä¹‹åçš„æ¸²æŸ“æµç¨‹:

- **ç»„ä»¶:** Hey, React, æŠŠæˆ‘çš„çŠ¶æ€(state)å€¼è®¾ç½®ä¸º `1`.
- **React:** å½“çŠ¶æ€æ›´æ–°ä¸º `1` çš„æ—¶å€™, æŠŠå¯¹åº”çš„ UI è¿”å›ç»™æˆ‘å§.
- **ç»„ä»¶:**
  - è¿™æ˜¯æ¸²æŸ“çš„ç»“æœ: `<p>You clicked 1 times</p>`.
  - è®°å¾—æ‰§è¡Œè¿™ä¸ªå‰¯ä½œç”¨æ–¹æ³•: `() => { document.title = 'You clicked 1 times' }`.
- **React:** å¥½çš„, æ›´æ–° UI. Hey, æµè§ˆå™¨, æˆ‘å·²ç»ä¿®æ”¹äº† DOM äº†.
- **æµè§ˆå™¨:** å¥½çš„, æˆ‘æŠŠå®ƒä»¬ç»˜åˆ¶åˆ°å±å¹•ä¸­.
- **React:** OK, æˆ‘ç°åœ¨å¼€å§‹æ‰§è¡Œå‰¯ä½œç”¨æ–¹æ³•.
  - æ‰§è¡Œ `() => { document.title = 'You clicked 1 times' }`.

---

### æ¯æ¬¡æ¸²æŸ“çš„æ‰€æœ‰å€¼éƒ½å±äºå½“æ¬¡æ¸²æŸ“

**æˆ‘ä»¬çŸ¥é“äº†, å‰¯ä½œç”¨æ–¹æ³•åœ¨æ¯æ¬¡æ¸²æŸ“ä¹‹åéƒ½ä¼šæ‰§è¡Œ, ä»æ¦‚å¿µä¸Šå¯ä»¥å°†å‰¯ä½œç”¨æ–¹æ³•ç†è§£ä¸ºç»„ä»¶è¾“å‡ºå†…å®¹çš„ä¸€éƒ¨åˆ†, å¹¶ä¸”å‰¯ä½œç”¨æ–¹æ³•èƒ½å¤Ÿ"çœ‹åˆ°"å½“æ¬¡æ¸²æŸ“çš„ props å’Œ state.**

ç°åœ¨æˆ‘ä»¬æ¥åšä¸€æ¬¡å®éªŒ. æŸ¥çœ‹ä¸‹é¢çš„ä»£ç :

```jsx
function Counter() {
  const [count, setCount] = useState(0)
  // highlight-start
  useEffect(() => {
    setTimeout(() => {
      console.log(`You clicked ${count} times`)
    }, 3000)
  })
  // highlight-end
  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  )
}
```

å¦‚æœæˆ‘åœ¨æ¯æ¬¡å»¶è¿Ÿçš„æ—¶é—´æ®µå†…ç‚¹å‡»å¤šæ¬¡, æœ€ç»ˆè¾“å‡ºçš„å€¼ä¼šæ˜¯æ€æ ·çš„å‘¢?

---

å‰§é€

---

ä½ å¯èƒ½ä¼šè®¤ä¸ºè¿™æ˜¯ä¸ªç³Šå¼„ä½ çš„é¢˜ç›®, æœ€ç»ˆçš„ç»“æœä¼šå¾ˆå‡ºäººæ„æ–™. å…¶å®å¹¶ä¸æ˜¯! æˆ‘ä»¬æ¥çœ‹è¿™ä¸€ç³»åˆ—çš„è¾“å‡º -- æ¯ä¸€ä¸ªè¾“å‡ºéƒ½å±äºç‰¹å®šçš„æ¸²æŸ“, å› æ­¤æ¯ä¸€æ¬¡è¾“å‡ºéƒ½æ˜¯è‡ªå·±çš„ `count` å€¼. [CodeSandbox ä»£ç ç¤ºä¾‹](https://codesandbox.io/s/lyx20m1ol).

![timeout_counter](./timeout_counter.gif)

ä½ å¯èƒ½ä¼šè§‰å¾—: "å½“ç„¶æ˜¯è¿™æ ·è¾“å‡ºçš„, å¦åˆ™ä¼šæ€æ ·è¾“å‡ºå‘¢?"

ä¸è¿‡, `this.state` åœ¨ç±»ç»„ä»¶ä¸­å¹¶ä¸æ˜¯è¿™æ ·å·¥ä½œçš„. å¾ˆå¤šäººä¼šæŠŠ `useEffect` çœ‹ä½œæ˜¯å’Œ[ç±»ä¸­](https://codesandbox.io/s/kkymzwjqz3)çš„`componentDidUpdate` ç±»ä¼¼çš„æ–¹æ³•:

```jsx
  componentDidUpdate() {
    setTimeout(() => {
      console.log(`You clicked ${this.state.count} times`);
    }, 3000);
  }
```

å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·çš„, `this.state.count` å§‹ç»ˆæ˜¯æœ€æ–°çš„ `count` å€¼, ä½†æ˜¯ `useEffect` ä¸­çš„åˆ™æ˜¯å½“æ¬¡æ¸²æŸ“çš„å€¼, å› æ­¤ä»¥ä¸Šä»£ç çš„ç»“æœ, è¾“å‡ºçš„ä¼šæ˜¯ `5`:

![timeout_counter_class](./timeout_counter_class.gif)

æˆ‘è§‰å¾—æœ‰ç‚¹è®½åˆºçš„æ˜¯, Hooks çš„å®ç°ååˆ†ä¾èµ– JavaScript ä¸­çš„é—­åŒ…,
I think itâ€™s ironic that Hooks rely so much on JavaScript closures, and yet itâ€™s the class implementation that suffers from the canonical wrong-value-in-a-timeout confusion thatâ€™s often associated with closures. This is because the actual source of the confusion in this example is the mutation (React mutates this.state in classes to point to the latest state) and not closures themselves.

**å½“æˆ‘ä»¬éœ€è¦é”å®šä¸€ä¸ªæ°¸è¿œä¸ä¼šå˜åŒ–çš„å€¼çš„æ—¶å€™, ä½¿ç”¨é—­åŒ…æ˜¯æœ€åˆé€‚çš„æ‰‹æ®µ. è¿™ä½¿å¾—æˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½å¤Ÿæ¨å‡ºæ­£ç¡®ç­”æ¡ˆ, å› ä¸ºå½’æ ¹ç»“åº•ä½ æ­£åœ¨è¯»å–çš„å€¼å§‹ç»ˆæ˜¯ä¸€ä¸ªå¸¸é‡.** æ—¢ç„¶æˆ‘ä»¬ç°åœ¨å·²ç»çŸ¥é“äº†å¦‚ä½•ç»´æŒæ¸²æŸ“æ—¶çš„ props å’Œ state, å¯ä»¥å¼€å§‹å°è¯•[ä½¿ç”¨é—­åŒ…](https://codesandbox.io/s/w7vjo07055)å¯¹ class ç‰ˆæœ¬çš„ä»£ç è¿›è¡Œæ”¹é€ .

### é€†æµè€Œä¸Š

ç°åœ¨æˆ‘ä»¬å·²ç»å¾—åˆ°äº†ä¸€ä¸ªå…±è¯†: å‡½æ•°å¼ç»„ä»¶åœ¨æ¸²æŸ“æ—¶, å†…éƒ¨çš„æ¯ä¸€é¡¹(åŒ…æ‹¬äº‹ä»¶å¤„ç†å™¨, å‰¯ä½œç”¨æ–¹æ³•, è¶…æ—¶æ—¶é—´, API è°ƒç”¨ç­‰)éƒ½ä¼š"æ•æ‰"æ¸²æŸ“å½“æ—¶çš„ props å’Œ state.

å› æ­¤ä»¥ä¸‹ä¸¤ä¸ªä¾‹å­å…¶å®æ˜¯ä¸€è‡´çš„:

```jsx
function Example(props) {
  useEffect(() => {
    setTimeout(() => {
      // highlight-next-line
      console.log(props.counter)
    }, 1000)
  })
  // ...
}
```

```jsx
function Example(props) {
  // highlight-next-line
  const counter = props.counter
  useEffect(() => {
    setTimeout(() => {
      // highlight-next-line
      console.log(counter)
    }, 1000)
  })
  // ...
}
```

**ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡º, ä¸ç®¡æ˜¯ä¸æ˜¯åœ¨ç»„ä»¶ä¸­æå‰è¯»å– state æˆ–è€… props çš„å€¼, å¯¹å‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å–åˆ°çš„ç»“æœå…¶å®éƒ½æ²¡æœ‰å½±å“.** åœ¨å•æ¬¡æ¸²æŸ“çš„ä½œç”¨åŸŸå†…, props å’Œ state å§‹ç»ˆä¼šä¿æŒä¸å˜. (å°† props è§£æ„èƒ½å¤Ÿä½¿å¾—è¿™ä¸ªæ¦‚å¿µæ›´å®¹æ˜“ç†è§£.)

åœ¨æŸäº›åœºæ™¯ä¸‹, æˆ‘ä»¬å¯èƒ½ä¼šå¸Œæœ›èƒ½å¤Ÿå‰¯ä½œç”¨å‡½æ•°çš„å›è°ƒä¸­è¯»å–åˆ°æœ€æ–°çš„å€¼è€Œä¸æ˜¯æ¸²æŸ“å½“æ—¶çš„å€¼. æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ `ref`, åœ¨è¿™ç¯‡[æ–‡ç« ](https://overreacted.io/how-are-function-components-different-from-classes/)çš„æœ€åä¸€éƒ¨åˆ†æˆ‘ä»¬æœ‰æåŠåˆ°ç›¸å…³çš„æ¦‚å¿µ.

æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯, å½“æˆ‘ä»¬å¸Œæœ›åœ¨è¿‡å»çš„æ¸²æŸ“ä¸­è¯»å–åˆ°æœªæ¥çš„ props å’Œ state æ—¶, æˆ‘ä»¬å®é™…ä¸Šåœ¨é€†æµå‰è¿›. è¿™å½“ç„¶æ²¡æœ‰é”™(åœ¨æŸäº›æƒ…å†µä¸‹ç”šè‡³æ˜¯å¿…è¦çš„), ä¸è¿‡è¿™æ ·çš„åšæ³•çœ‹èµ·æ¥æ¯”è¾ƒ"ä¸å¹²å‡€", è¿åäº†ç°æœ‰çš„æ¨¡å¼. å…¶å® React å›¢é˜Ÿæ˜¯åˆ»æ„æŠŠå‡½æ•°å¼ç»„ä»¶çš„è¡Œä¸ºè®¾è®¡æˆè¿™æ ·çš„, å¦‚æ­¤ä¾èµ–, ç”¨æˆ·å°±èƒ½å¤Ÿå¾ˆæ˜¾è€Œæ˜“è§åœ°å‘ç°ä»£ç çš„ç¼ºé™·. åœ¨ç±»å¼ç»„ä»¶ä¸­, å‘ç°è¿™ç±»é—®é¢˜å°±æ¯”è¾ƒå›°éš¾.

è¿™é‡Œæœ‰[å¦ä¸€ä¸ªç‰ˆæœ¬è®¡æ—¶å™¨çš„ä¾‹å­](https://codesandbox.io/s/rm7z22qnlp), æ¨¡æ‹Ÿäº†ç±»å¼ç»„ä»¶çš„è¡Œä¸º:

```jsx
function Example() {
  const [count, setCount] = useState(0);
  // highlight-next-line
  const latestCount = useRef(count);

  useEffect(() => {
  // highlight-start
    // Set the mutable latest value
    latestCount.current = count;
  // highlight-end
    setTimeout(() => {
    // highlight-start
      // Read the mutable latest value
      console.log(`You clicked ${latestCount.current} times`);
    // highlight-end
    }, 3000);
  });
  // ...
```

![timeout_counter_refs](./timeout_counter_refs.gif)

åœ¨ React ä¸­ä¿®æ”¹(mutate)æŸäº›å€¼æˆ–è®¸çœ‹èµ·æ¥ä¼šå¾ˆå¥‡æ€ª. ä½†æ˜¯å…¶å®åœ¨ç±»å¼ç»„ä»¶ä¸­, React å°±æ˜¯è¿™æ ·ä¸º `this.state` èµ‹å€¼çš„. ä¸è·å–æ¸²æŸ“å½“æ—¶çš„ props å’Œ state ä¸åŒçš„æ˜¯, è¯»å– `latestCount.current` çš„å€¼, è·å–åˆ°çš„ç»“æœæ— æ³•å¾—åˆ°ä»»ä½•çš„ä¿è¯, åœ¨æŸä¸€æ¬¡å›è°ƒä¸­æ˜¯è¿™æ ·çš„ç»“æœ, åˆ°äº†ä¸‹ä¸€æ¬¡æˆ–è®¸åˆä¸ä¸€æ ·äº†. å› ä¸ºå®ƒçš„å€¼æ˜¯å¯å˜çš„. è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ, æˆ‘ä»¬ä¸æ„¿æ„å°†è¿™æ ·çš„è¡Œä¸ºè®¾ç½®æˆé»˜è®¤è¡Œä¸º.

### Cleanup å‡½æ•°

[æ–‡æ¡£ä¸­æåˆ°](https://reactjs.org/docs/hooks-effect.html#effects-with-cleanup), æŸäº›å‰¯ä½œç”¨è¿˜éœ€è¦å­˜åœ¨å¯¹åº”çš„æ¸…é™¤å‰¯ä½œç”¨çš„é˜¶æ®µ. æœ¬è´¨ä¸Šæ¥è¯´, åœ¨è¿™ä¸ªé˜¶æ®µä¸­æˆ‘ä»¬åšçš„äº‹æƒ…, å°±æ˜¯æ’¤é”€å‰¯ä½œç”¨(æ¯”å¦‚å–æ¶ˆè®¢é˜…äº‹ä»¶.)

æŸ¥çœ‹ä¸‹é¢çš„ä»£ç :

```jsx
useEffect(() => {
  ChatAPI.subscribeToFriendStatus(props.id, handleStatusChange)
  return () => {
    ChatAPI.unsubscribeFromFriendStatus(props.id, handleStatusChange)
  }
})
```

å‡å¦‚åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶, `props` çš„å€¼ä¸º `{id: 10}`, ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶, å€¼ä¸º `{id: 20}`. ä½ æˆ–è®¸ä¼šè®¤ä¸ºæ¸²æŸ“æµç¨‹æ˜¯è¿™æ ·å‘ç”Ÿçš„:

- React æ¸…é™¤ props ä¸º `{id: 10}` æ—¶çš„å‰¯ä½œç”¨.
- React ä¸º `{id: 20}` æ¸²æŸ“å¯¹åº”çš„ UI.
- React ä¸º `{id: 20}` æ‰§è¡Œå¯¹åº”çš„å‰¯ä½œç”¨æ–¹æ³•.

(ä½†æ˜¯å®é™…æƒ…å†µå¹¶ä¸æ˜¯è¿™æ ·çš„.)

å¦‚æœä½ å»ºç«‹ä»¥ä¸Šçš„å¿ƒæ™ºæ¨¡å‹, å°±ä¼šè®¤ä¸ºæ¸…é™¤å‰¯ä½œç”¨çš„å‡½æ•°"çœ‹åˆ°äº†"æ—§çš„ props, å› ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯åœ¨é‡æ–°æ¸²æŸ“ä¹‹å‰æ‰§è¡Œçš„, ç„¶åæ–°çš„å‰¯ä½œç”¨å‡½æ•°"çœ‹åˆ°äº†"æ–°çš„ props. è¿™ä¸ªå¿ƒæ™ºæ¨¡å‹å¯¹äºç±»å¼ç»„ä»¶æ¥è¯´, æ˜¯å®Œå…¨æ­£ç¡®çš„, ä½†æ˜¯å¯¹äºå‡½æ•°å¼ç»„ä»¶, æƒ…å†µå¹¶ä¸æ˜¯è¿™æ ·. æˆ‘ä»¬æ¥çœ‹çœ‹åŸå› æ˜¯ä»€ä¹ˆ.

React æ‰§è¡Œå‰¯ä½œç”¨æ–¹æ³•çš„æ—¶æœºæ˜¯[æµè§ˆå™¨ç»˜åˆ¶éœ€è¦æ¸²æŸ“çš„å†…å®¹ä¹‹å](https://medium.com/@dan_abramov/this-benchmark-is-indeed-flawed-c3d6b5b6f97f). è¿™æ ·èƒ½å¤Ÿä½¿å¾—æˆ‘ä»¬çš„åº”ç”¨ä½“éªŒæ›´ä½³, ä¸é˜»å¡æµè§ˆå™¨çš„æ¸²æŸ“. æ¸…é™¤å‰¯ä½œç”¨çš„æ–¹æ³•åŒæ—¶ä¹Ÿä¼šå»¶è¿Ÿ. **å‰ä¸€æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨ç›´åˆ°ä½¿ç”¨æ–°çš„ props å¼€å§‹é‡æ–°æ¸²æŸ“, æ‰ä¼šè¢«æ¸…é™¤:**

- React ä¸º `{id: 20}` æ¸²æŸ“å¯¹åº”çš„ UI.
- æµè§ˆå™¨ç»˜åˆ¶å†…å®¹, æˆ‘ä»¬çœ‹åˆ° `{id: 20}` å¯¹åº”çš„ UI.
- React æ¸…é™¤ props ä¸º `{id: 10}` æ—¶çš„å‰¯ä½œç”¨.
- React ä¸º `{id: 20}` æ‰§è¡Œå¯¹åº”çš„å‰¯ä½œç”¨æ–¹æ³•.

ä½ æˆ–è®¸ä¼šè§‰å¾—å¥‡æ€ª, ä¸ºä»€ä¹ˆå‰ä¸€æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨æ–¹æ³•è¯»å–åˆ°çš„æ˜¯å‰ä¸€æ¬¡æ¸²æŸ“çš„ props å€¼, è€Œä¸æ˜¯æ­¤åˆ»çš„ `{id: 20}`?

å…¶å®æˆ‘ä»¬ä¹‹å‰å·²ç»æåŠè¿‡è¿™ä¸ªè¯é¢˜...... ğŸ¤”

å…ˆå‰ç« èŠ‚çš„æ‘˜å½•:

> ç»„ä»¶æ¸²æŸ“æ—¶å†…éƒ¨çš„æ¯ä¸€ä¸ªå‡½æ•°(åŒ…æ‹¬äº‹ä»¶å¤„ç†å™¨, å‰¯ä½œç”¨å‡½æ•°, timeout å›è°ƒ, API è°ƒç”¨ç­‰), éƒ½ä¼š"æ•æ‰"å½“æ—¶çš„ props å’Œ state.

è¿™æ ·ä¸€æ¥, ç­”æ¡ˆå°±å¾ˆæ˜æ˜¾äº†. æ¸…é™¤å‰¯ä½œç”¨çš„å‡½æ•°æ²¡æœ‰è¯»å–æœ€æ–°çš„ props, å®ƒå§‹ç»ˆä¼šè¯»å–æ¸²æŸ“å½“æ—¶æ‰€å®šä¹‰çš„ props å’Œ state:

```jsx
// é¦–æ¬¡æ¸²æŸ“ props æ˜¯ {id: 10}
function Example() {
  // ...
  useEffect(
    // é¦–æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      ChatAPI.subscribeToFriendStatus(10, handleStatusChange)
      // highlight-start
      // é¦–æ¬¡æ¸²æŸ“çš„æ¸…é™¤å‰¯ä½œç”¨å‡½æ•°
      return () => {
        ChatAPI.unsubscribeFromFriendStatus(10, handleStatusChange)
      }
      // highlight-end
    }
  )
  // ...
}
// ç¬¬äºŒæ¬¡æ¸²æŸ“ props æ˜¯ {id: 20}
function Example() {
  // ...
  useEffect(
    // ç¬¬äºŒæ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      ChatAPI.subscribeToFriendStatus(20, handleStatusChange)
      // ç¬¬äºŒæ¬¡æ¸²æŸ“çš„æ¸…é™¤å‰¯ä½œç”¨å‡½æ•°
      return () => {
        ChatAPI.unsubscribeFromFriendStatus(20, handleStatusChange)
      }
    }
  )
  // ...
}
```

Kingdoms will rise and turn into ashes, the Sun will shed its outer layers to be a white dwarf, and the last civilization will end. But nothing will make the props â€œseenâ€ by the first render effectâ€™s cleanup anything other than {id: 10}.

Thatâ€™s what allows React to deal with effects right after painting â€” and make your apps faster by default. The old props are still there if our code needs them.

### åŒæ­¥ å¿½ç•¥ç”Ÿå‘½å‘¨æœŸ

æˆ‘å–œæ¬¢ React çš„åŸå› ä¹‹ä¸€æ˜¯, å®ƒç»Ÿä¸€æè¿°äº†é¦–æ¬¡æ¸²æŸ“çš„ç»“æœå’Œå¯¹åº”çš„æ›´æ–°. è¿™ç§æ¨¡å¼[å‡å°‘äº†ç¨‹åºçš„ç†µ](https://overreacted.io/the-bug-o-notation/). <mark>?</mark>

ä¸¾ä¸ªä¾‹å­, å¦‚æœæˆ‘çš„ç»„ä»¶æ˜¯ä¸‹é¢è¿™æ ·çš„:

```jsx
function Greeting({ name }) {
  return <h1 className="Greeting">Hello, {name}</h1>
}
```

ä¸ç®¡æ˜¯å…ˆæ¸²æŸ“ `<Greeting name="Dan" />`, ç„¶åæ¸²æŸ“ `<Greeting name="Yuzhi" />`, è¿˜æ˜¯ç›´æ¥æ¸²æŸ“ `<Greeting name="Yuzhi" />`. æœ€åçš„ç»“æœéƒ½æ˜¯çœ‹åˆ°å±å¹•ä¸­å‘ˆç°: "Hello, Yuzhi".

äººä»¬å¸¸è¯´: é‡è¦çš„æ˜¯æ—…ç¨‹è€Œä¸æ˜¯ç›®çš„åœ°. ä½†æ˜¯åœ¨ React ä¸­, æƒ…å†µå°±ä¸æ˜¯è¿™æ ·äº†. **æˆ‘ä»¬åªå…³æ³¨ç»“æœ, è€Œéè¿‡ç¨‹.** ä¸¾ä¸ªä¾‹å­, åœ¨ jQuery ä¸­, æˆ‘ä»¬å…³æ³¨è¿‡ç¨‹, æ¯”å¦‚è¯´ä½¿ç”¨ `$.addClass` å’Œ `$.removeClass` æ¥æ“æ§æ ‡ç­¾çš„ `className`, è€Œåœ¨ React ä¸­, æˆ‘ä»¬ä¼šç›´æ¥å£°æ˜ `className` åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„(å…³æ³¨ç»“æœ).

**React ä¼šæ ¹æ®å½“å‰çš„ props å’Œ state åŒæ­¥ DOM çš„å†…å®¹.** åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­, æŒ‚è½½(mount)å’Œæ›´æ–°(update)å…¶å®æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«.

æˆ‘ä»¬å¯ä»¥ä»¥åŒæ ·çš„è§’åº¦æ€è€ƒå‰¯ä½œç”¨å‡½æ•°. **`useEffect` å‡½æ•°ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ ¹æ® props å’Œ state åŒæ­¥ React æ ‘ä¹‹å¤–çš„å†…å®¹.**

```jsx
function Greeting({ name }) {
  // highlight-start
  useEffect(() => {
    document.title = "Hello, " + name
  })
  // highlight-end
  return <h1 className="Greeting">Hello, {name}</h1>
}
```

è¿™æ ·çš„å¿ƒæ™ºæ¨¡å‹å’Œæˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„ _æŒ‚è½½/æ›´æ–°/å¸è½½_ æœ‰ä¸€ç‚¹åŒºåˆ«. äº†è§£è¿™ä¸ªæ¨¡å‹å¾ˆé‡è¦. **å¦‚æœä½ å¸Œæœ›å®ç°çš„å‰¯ä½œç”¨å‡½æ•°, ä¼šæ ¹æ®æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“, è¿˜æ˜¯é‡æ–°æ¸²æŸ“, æœ‰ä¸åŒçš„è¡¨ç°å½¢å¼, é‚£ä¹ˆä½ å°±æ˜¯åœ¨é€†æµå‰è¿›!** å¦‚æœæˆ‘ä»¬çš„ç»“æœä¾èµ–çš„æ˜¯"è¿‡ç¨‹"è€Œé"ç›®çš„åœ°", åŒæ­¥çš„è¿‡ç¨‹å°±ä¼šå¤±è´¥.

ä¸ç®¡æˆ‘ä»¬æ˜¯æŒ‰ç…§å±æ€§(A, B, C)çš„é¡ºåºè¿›è¡Œæ¸²æŸ“, è¿˜æ˜¯ç›´æ¥ç”¨ C è¿›è¡Œæ¸²æŸ“, å…¶å®åŸºæœ¬ä¸Šæ²¡æœ‰ä»€ä¹ˆå·®åˆ«. å”¯ä¸€çš„å·®åˆ«å¯èƒ½æ˜¯åœ¨è¯·æ±‚æ•°æ®çš„è¿‡ç¨‹ä¸­å­˜åœ¨çš„. ä½†æ˜¯æœ€ç»ˆçš„ç»“æœå§‹ç»ˆæ˜¯ç›¸åŒçš„.

æœ‰ä¸€ä¸ªæ¯‹åº¸ç½®ç–‘çš„ç‚¹æ˜¯: æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œæ‰€æœ‰çš„å‰¯ä½œç”¨å…¶å®å¾ˆå½±å“æ•ˆç‡. (åŒæ—¶åœ¨æŸäº›æƒ…å†µä¸‹, ä¼šå¯¼è‡´æ— é™å¾ªç¯.)

é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆä¿®å¤å®ƒå‘¢?

### å‘Šè¯‰ React å‰¯ä½œç”¨å‡½æ•°ä½•æ—¶ä¼šäº§ç”Ÿå˜åŒ–

æˆ‘ä»¬å·²ç»å­¦ä¹ äº† React å¦‚ä½• diff DOM. React å¹¶æ²¡æœ‰åœ¨æ¯æ¬¡æ¸²æŸ“çš„æ—¶å€™æ›´æ–°æ‰€æœ‰çš„ DOM, è€Œæ˜¯æ›´æ–°æœ‰ä¿®æ”¹çš„éƒ¨åˆ†.

å½“ä½ æ›´æ–°ä»¥ä¸‹ç»„ä»¶

```jsx
<h1 className="Greeting">Hello, Dan</h1>
```

ä¸º:

```jsx
<h1 className="Greeting">Hello, Yuzhi</h1>
```

çš„æ—¶å€™, React çœ‹åˆ°çš„æ˜¯è¿™æ ·ä¸¤ä¸ªå¯¹è±¡:

```jsx
const oldProps = { className: "Greeting", children: "Hello, Dan" }
const newProps = { className: "Greeting", children: "Hello, Yuzhi" }
```

React ä¼šæŸ¥çœ‹æ¯ä¸€ä¸ª props, ç„¶ååˆ¤æ–­å‡º `children` æœ‰å˜åŒ–, å†æ›´æ–° DOM, `className` æ²¡æœ‰å˜åŒ–, å› æ­¤ä¸éœ€è¦æ›´æ–°. æ‰€ä»¥ React åªéœ€è¦è¿™æ ·å¤„ç†å³å¯:

```jsx
domNode.innerText = "Hello, Yuzhi"
// No need to touch domNode.className
```

**é‚£ä¹ˆé’ˆå¯¹å‰¯ä½œç”¨å‡½æ•°, æ˜¯å¦ä¹Ÿèƒ½å¤Ÿåªåœ¨å¿…è¦çš„æ—¶å€™æ›´æ–°å‘¢?**

ä¸¾ä¸ªä¾‹å­, åœ¨ä»¥ä¸‹å‡½æ•°ä¸­, ç»„ä»¶ä¼šå› ä¸º state çš„æ›´æ–°è€Œæ›´æ–°:

```jsx
function Greeting({ name }) {
  const [counter, setCounter] = useState(0)

  useEffect(() => {
    document.title = "Hello, " + name
  })

  return (
    <h1 className="Greeting">
      Hello, {name}
      // highlight-start
      <button onClick={() => setCounter(count + 1)}>Increment</button>
      // highlight-end
    </h1>
  )
}
```

ä½†æ˜¯æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°å¹¶æ²¡æœ‰ç”¨åˆ° `counter` çš„å€¼. **å‰¯ä½œç”¨å‡½æ•°åªä¼šæ ¹æ® `name` çš„å±æ€§å€¼æ›´æ–° `document.title`, ä½†æ˜¯ `name` å±æ€§å€¼å§‹ç»ˆæ˜¯ä¸€è‡´çš„.** åœ¨æ¯æ¬¡ `counter` å€¼å˜åŒ–çš„æ—¶å€™ç»™ `document.title` é‡æ–°èµ‹å€¼æ˜¯å®Œå…¨æ²¡æœ‰å¿…è¦çš„.

é‚£ä¹ˆ React å¦‚ä½•åˆ†è¾¨å‰¯ä½œç”¨å‡½æ•°çš„æ›´æ–°ä¸å¦å‘¢?

```jsx
let oldEffect = () => {
  document.title = "Hello, Dan"
}
let newEffect = () => {
  document.title = "Hello, Dan"
}
// React èƒ½å¤Ÿçœ‹å‡ºè¿™ä¸¤ä¸ªå‡½æ•°åšäº†åŒæ ·çš„äº‹æƒ…å—?
```

å¹¶ä¸èƒ½, React åœ¨è°ƒç”¨å‡½æ•°ä¹‹å‰, æ˜¯æ— æ³•åˆ†æå‡ºè¿™ä¸ªå‡½æ•°æ‰€åšçš„äº‹æƒ…çš„. <mark>(The source doesnâ€™t really contain specific values, it just closes over the name prop.)</mark>

å› æ­¤, æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ–¹æ³•é¿å…åœ¨ä¸å¿…è¦çš„æƒ…å†µä¸‹æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°, æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªä¾èµ–æ•°ç»„å‚æ•°åˆ° `useEffect` æ–¹æ³•ä¸­, åªæœ‰å½“ä¾èµ–æ•°ç»„ä¸­çš„å€¼å˜åŒ–çš„æ—¶å€™, å‰¯ä½œç”¨å‡½æ•°æ‰ä¼šé‡æ–°æ‰§è¡Œ.

```jsx
useEffect(() => {
  document.title = "Hello, " + name
  // highlight-next-line
}, [name]) // ä¾èµ–æ•°ç»„å‚æ•°
```

**ä»¥ä¸Šçš„åœºæ™¯å°±å¥½åƒæ˜¯æˆ‘ä»¬åœ¨å‘Šè¯‰ React: "Hey React, æˆ‘çŸ¥é“ä½ ä¸èƒ½çœ‹åˆ°å‡½æ•°å†…éƒ¨çš„å†…å®¹, ä½†æ˜¯æˆ‘å¯ä»¥ç¡®ä¿å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„æ¸²æŸ“ç›¸å…³å‚æ•°åªæœ‰ `name`. "**

å¦‚æœå‰ä¸€æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ `name` çš„å€¼ä¸è¿™ä¸€æ¬¡æ‰§è¡Œæ—¶ä¸€è‡´çš„è¯, é‚£ä¹ˆå°±å¯ä»¥è·³è¿‡æ­¤æ¬¡å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œ:

```jsx
const oldEffect = () => {
  document.title = "Hello, Dan"
}
const oldDeps = ["Dan"]

const newEffect = () => {
  document.title = "Hello, Dan"
}
const newDeps = ["Dan"]

// React æ— æ³•çœ‹åˆ°éŸ©å¼å†…éƒ¨çš„æƒ…å†µ, ä½†æ˜¯å®ƒå¯ä»¥å¯¹æ¯”è¿™äº›ä¾èµ–å‚æ•°
// ç”±äºä¾èµ–å‚æ•°çš„å€¼å§‹ç»ˆå‰åæ˜¯ä¸€è‡´çš„, é‚£ä¹ˆå°±ä¸éœ€è¦æ‰§è¡Œæ–°çš„å‰¯ä½œç”¨å‡½æ•°
```

å¦‚æœä¾èµ–æ•°ç»„ä¸­çš„æŸä¸ªå€¼åœ¨æ¸²æŸ“å‰åæœ‰æ‰€å·®å¼‚, é‚£ä¹ˆè¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°å°±å¿…é¡»æ‰§è¡Œ. åŒæ­¥æ‰€æœ‰è¿™äº›å€¼.

### è¦ç¡®ä¿ä¾èµ–æ•°ç»„ä¸­çš„å‚æ•°çš„å‡†ç¡®æ€§ ä¸è¦æ¬ºéª— React

æ¬ºéª— React å…³äºä¾èµ–æ•°ç»„å€¼çš„å†…å®¹ä¼šå¸¦æ¥æ¯”è¾ƒä¸å¥½çš„å½±å“. <mark>Intuitively, this makes sense, but Iâ€™ve seen pretty much everyone who tries useEffect with a mental model from classes try to cheat the rules. (And I did that too at first!)</mark>

```jsx
function SearchResults() {
  async function fetchData() {
    // ...
  }

  useEffect(() => {
    fetchData()
  }, []) //  è¿™æ ·çš„å†™æ³•æ˜¯åˆç†çš„å—? åœ¨æŸäº›åœºæ™¯ä¸‹ä¸åˆç†, æˆ‘ä»¬å¯ä»¥æœ‰æ›´å¥½çš„æ–¹å¼æ¥ç¼–å†™è¿™éƒ¨åˆ†ä»£ç 

  // ...
}
```

(å…³äº [Hooks çš„å¸¸è§é—®é¢˜](https://reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies)ä¸­, å·²ç»è¯¦ç»†è¯´æ˜äº†é’ˆå¯¹è¿™ä¸ªé—®é¢˜çš„æ­£ç¡®åšæ³•. æˆ‘ä»¬å›åˆ°ç°åœ¨ä¾‹å­:)

"ä½†æ˜¯æˆ‘åªå¸Œæœ›åœ¨ç»„ä»¶æŒ‚è½½çš„æ—¶å€™æ‰§è¡Œè¿™ä¸ªæ–¹æ³•!" ä½ æˆ–è®¸ä¼šè¿™æ ·è¯´. æˆ‘ä»¬è¦è®°ä½è¿™æ ·ä¸€ä¸ªåŸåˆ™: å¦‚æœä½ å£°æ˜äº†ä¾èµ–å‚æ•°, **æ‰€æœ‰ç»„ä»¶å†…éƒ¨çš„å€¼, åªè¦è¢«å‰¯ä½œç”¨å‡½æ•°ä½¿ç”¨, å°±ä¸€å®šè¦å£°æ˜åœ¨ä¾èµ–å‚æ•°ä¸­.** åŒ…æ‹¬ props, state, å‡½æ•°ç­‰ä»»ä½•åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨çš„å€¼.

ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°ä¸€äº›é—®é¢˜. æ¯”å¦‚, ä½ å¯èƒ½ä¼šé‡åˆ°æ— é™å¾ªç¯è¯·æ±‚çš„æƒ…å†µ, æˆ–è€…æ˜¯æŸä¸ª socket ä¸æ–­è¢«é‡æ–°åˆ›å»º. **é’ˆå¯¹è¿™äº›é—®é¢˜çš„å¤„ç†æ–¹å¼å¹¶ä¸æ˜¯åˆ é™¤è¿™ä¸ªä¾èµ–.** åé¢æˆ‘ä»¬ä¼šè°ˆåˆ°å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜.

åœ¨æˆ‘ä»¬æŸ¥çœ‹è§£å†³æ–¹æ¡ˆä¹‹å‰, å…ˆæ›´æ·±å…¥åœ°äº†è§£ä¸€ä¸‹æˆ‘ä»¬çš„é—®é¢˜.

### å½“ä½ å¯¹ React æ’’è° ä¼ å…¥äº†é”™è¯¯çš„ä¾èµ–å‚æ•°ä¼šå‘ç”Ÿä»€ä¹ˆ

å¦‚æœä¾èµ–æ•°ç»„ä¸­åŒ…å«äº†æ‰€æœ‰å‰¯ä½œç”¨å‡½æ•°ä¼šç”¨åˆ°çš„å€¼, React å°±èƒ½å¤ŸçŸ¥é“ä½•æ—¶éœ€è¦é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°:

```jsx
useEffect(() => {
  document.title = "Hello, " + name
  // highlight-next-line
}, [name])
```

![](./deps-compare-correct.gif)

(ä¾èµ–æ•°ç»„ä¸­çš„å€¼åœ¨æ¸²æŸ“å‰åæœ‰æ‰€å·®å¼‚, å› æ­¤æˆ‘ä»¬éœ€è¦é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°.)

å¦‚æœæˆ‘ä»¬åœ¨ä¾èµ–æ•°ç»„ä¸­ä¼ å…¥ç©ºæ•°ç»„`[]`, æ–°çš„å‰¯ä½œç”¨å‡½æ•°å°±ä¸ä¼šè¢«æ‰§è¡Œ:

```jsx
useEffect(() => {
  document.title = "Hello, " + name
  // highlight-next-line
}, []) // ç¼ºå°‘äº† name å‚æ•°
```

![](./deps-compare-wrong.gif)

(ä¾èµ–æ•°ç»„å‰åä¸€è‡´, å› æ­¤è·³è¿‡è¿™æ¬¡å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œ)

é€šè¿‡ä»¥ä¸Šçš„åœºæ™¯å¯¹æ¯”, é—®é¢˜å°±å¾ˆæ˜æ˜¾åœ°ä½“ç°å‡ºæ¥äº†. <mark>But the intuition can fool you in other cases where a class solution â€œjumps outâ€ from your memory.</mark>

ä¸¾ä¸ªä¾‹å­, æ¯”å¦‚æˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ªè®¡æ•°å™¨, æ¯éš”ä¸€ç§’æ•°å­—åŠ  1. å¦‚æœæ˜¯ç±»å¼ç»„ä»¶çš„è¯, æˆ‘ä»¬ä¼šè¿™æ ·å®ç°å®ƒ: åœ¨ç»„ä»¶æŒ‚è½½çš„æ—¶å€™è®¾ç½®è®¡æ—¶å™¨å‡½æ•°, ç»„ä»¶å¸è½½çš„æ—¶å€™æ¸…æ¥š.

è¿™æ˜¯å…·ä½“çš„[ä»£ç ç¤ºä¾‹](https://codesandbox.io/s/n5mjzjy9kl). å½“æˆ‘ä»¬æƒ³è¦æŠŠç±»å¼ç»„ä»¶è½¬æ¢æˆå‡½æ•°å¼ç»„ä»¶çš„æ—¶å€™, ä¼šä¹ æƒ¯æ€§åœ°ä½¿ç”¨ `useEffect`, è®¾ç½®ä¾èµ–å‚æ•°ä¸º `[]`, è¡¨ç¤ºå¸Œæœ›å‰¯ä½œç”¨å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡.

```jsx
function Counter() {
  const [count, setCount] = useState(0)

  useEffect(() => {
    const id = setInterval(() => {
      setCount(count + 1)
    }, 1000)
    return () => clearInterval(id)
    // highlight-next-line
  }, [])

  return <h1>{count}</h1>
}
```

ä½†æ˜¯çœŸæ­£æ‰§è¡Œäº†ä¼šå‘ç°, ç»“æœå¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€é¢„æœŸçš„é‚£æ ·. [ç¤ºä¾‹ä»£ç ](https://codesandbox.io/s/91n5z8jo7r).

å¦‚æœä½ çš„å¿ƒæ™ºæ¨¡å‹æ˜¯è¿™æ ·çš„: "ä¾èµ–çš„ä½œç”¨æ˜¯è®©æˆ‘å£°æ˜ä»€ä¹ˆæ—¶å€™éœ€è¦é‡æ–°è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œ", é‚£ä¹ˆä½ å†™å‡ºæ¥çš„ä»£ç å°±ä¼šå¾ˆå±é™©, å°±åƒä¸Šé¢çš„ä¾‹å­ä¸€æ ·. ä½†æ˜¯é—®é¢˜æ˜¯, ä½ å¸Œæœ›åªè§¦å‘ä¸€æ¬¡å‰¯ä½œç”¨æ–¹æ³•, å› ä¸ºè¿™æ˜¯ä¸€ä¸ªé—´éš”æ‰§è¡Œçš„ API, å®é™…ä¸Šå¹¶æ²¡æœ‰é”™, ä½†æ˜¯ä¸ºä»€ä¹ˆä¼šå¸¦æ¥é—®é¢˜å‘¢?

ä¹‹å‰å·²ç»æåˆ°è¿‡, å‰¯ä½œç”¨å‡½æ•°ä¸­ä½¿ç”¨åˆ°çš„*æ‰€æœ‰*å€¼, æˆ‘ä»¬éƒ½è¦åœ¨ä¾èµ–å‚æ•°æ•°ç»„ä¸­å£°æ˜. ç”±äºå†…éƒ¨ä½¿ç”¨åˆ°äº† `count`, ä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨ä¾èµ–å‚æ•°æ•°ç»„ä¸­å£°æ˜, å› æ­¤ä¼šå¼•èµ· bug.

åœ¨é¦–æ¬¡æ¸²æŸ“çš„æ—¶å€™, `count` çš„å€¼æ˜¯ `0`. `setCount(count + 1)` åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶å®é™…æ‰§è¡Œçš„æ˜¯ `setCount(0 + 1)`. **ä½†æ˜¯å› ä¸ºæˆ‘ä»¬å£°æ˜çš„ä¾èµ–æ•°ç»„å‚æ•°ä¸­æ•°ç»„å€¼ä¸º `[]`, å› æ­¤å‰¯ä½œç”¨å‡½æ•°ä¸ä¼šå˜åŒ–, æ¯éš”ä¸€ç§’æ‰§è¡Œçš„å‡½æ•°éƒ½æ˜¯ `setCount(0 + 1)`**:

```jsx
// é¦–æ¬¡æ¸²æŸ“, state æ˜¯ 0
function Counter() {
  // ...
  useEffect(
    // é¦–æ¬¡æ¸²æŸ“çš„å‰¯ä½œç”¨å‡½æ•°
    () => {
      const id = setInterval(() => {
        // highlight-next-line
        setCount(0 + 1) // å§‹ç»ˆæ˜¯ setCount(1)
      }, 1000)
      return () => clearInterval(id)
    },
    // highlight-next-line
    [] // å§‹ç»ˆä¸ä¼šé‡æ–°æ‰§è¡Œ
  )
  // ...
}

// ä¸‹ä¸€æ¬¡æ¸²æŸ“, state æ˜¯ 1
function Counter() {
  // ...
  useEffect(
    // highlight-next-line
    // å‰¯ä½œç”¨å‡½æ•°è¢«å¿½ç•¥äº†, å› ä¸ºæˆ‘ä»¬çš„ä¾èµ–å‚æ•°ä¼ é€’é”™è¯¯.
    () => {
      const id = setInterval(() => {
        setCount(1 + 1)
      }, 1000)
      return () => clearInterval(id)
    },
    []
  )
  // ...
}
```

ç”±äºåœ¨ä¾èµ–å‚æ•°ä¸­ä¼ é€’äº†ä¸€ä¸ªç©ºæ•°ç»„, è¡¨æ˜äº†æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°ä¸ä¾èµ–ä»»ä½•å€¼, ä½†æ˜¯å®é™…ä¸Šå‰¯ä½œç”¨å‡½æ•°ä¸­å­˜åœ¨ä¾èµ–å…¶ä»–å€¼çš„éƒ¨åˆ†. 

æˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°ä½¿ç”¨åˆ°äº† `count`, è¿™ä¸ªå€¼å£°æ˜äºç»„ä»¶ä¹‹å†…, å‰¯ä½œç”¨å‡½æ•°ä¹‹å¤–:

```jsx
// highlight-next-line
 const count = // ...

  useEffect(() => {
    const id = setInterval(() => {
  // highlight-next-line
      setCount(count + 1);
    }, 1000);
    return () => clearInterval(id);
  }, []);
```

å› æ­¤, å°†ä¾èµ–å‚æ•°è®¾ç½®ä¸º `[]` ä¼šå¼•èµ· bug. React ä¼šæ¯”è¾ƒä¾èµ–é¡¹æ•°ç»„ä¸­çš„å†…å®¹, ç„¶åè·³è¿‡å‰¯ä½œç”¨å‡½æ•°çš„æ›´æ–°:

![](./interval-wrong.gif)

_(ä¾èµ–é¡¹ä¸­çš„å†…å®¹å§‹ç»ˆæ²¡æœ‰åŒºåˆ«, å› æ­¤è·³è¿‡å‰¯ä½œç”¨å‡½æ•°çš„æ›´æ–°)_

è¿™æ ·çš„é—®é¢˜æ¯”è¾ƒéš¾å®šä½. å› æ­¤, æˆ‘å»ºè®®å¤§å®¶åœ¨ä¼ é€’ä¾èµ–é¡¹å‚æ•°çš„æ—¶å€™å¯¹ React ä¿æŒè¯šå®, å£°æ˜æ‰€æœ‰ä¾èµ–å‚æ•°. (æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª [lint è§„åˆ™æ’ä»¶](https://github.com/facebook/react/issues/14920) ä»¥ä¾›ç”¨æˆ·åœ¨å¼€å‘é˜¶æ®µä½¿ç”¨.)

### Two Ways to Be Honest About Dependencies

1. åœ¨ä¾èµ–é¡¹æ•°ç»„ä¸­å£°æ˜å‰¯ä½œç”¨å‡½æ•°ä¸­çš„æ‰€æœ‰ä¾èµ–é¡¹
2. ç”¨å‡½æ•°çš„æ–¹å¼æ›´æ–°çŠ¶æ€
### Functional Updates and Google Docs

